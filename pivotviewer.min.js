//
//  HTML5 PivotViewer
//
//  Collection loader interface - used so that different types of data sources can be used
//
//  Original Code:
//    Copyright (C) 2011 LobsterPot Solutions - http://www.lobsterpot.com.au/
//    enquiries@lobsterpot.com.au
//
//  Enhancements:
//    Copyright (C) 2012-2013 OpenLink Software - http://www.openlinksw.com/
//
//  This software is licensed under the terms of the
//  GNU General Public License v2 (see COPYING)
//
///PivotViewer
var global={},PivotViewer=PivotViewer||{};PivotViewer.Version="v0.9.150-e5e48c4",PivotViewer.Models={},PivotViewer.Models.Loaders={},PivotViewer.Utils={},PivotViewer.Views={};var Debug=Debug||{};(function(e){var t={};e.publish=function(n,r){t[n]&&e.each(t[n],function(){this.apply(e,r||[])})},e.subscribe=function(e,n){return t[e]||(t[e]=[]),t[e].push(n),[e,n]},e.unsubscribe=function(n){var r=n[0];t[r]&&e.each(t[r],function(e){this==n[1]&&t[r].splice(e,1)})}})(jQuery),Debug.Log=function(e){window.console&&window.console.log&&typeof debug!="undefined"&&debug==1&&window.console.log(e)},window.requestAnimFrame=function(e){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e){window.setTimeout(e,1e3/60)}}(),PivotViewer.Utils.EscapeMetaChars=function(e){return e.replace(/\|/gi,"\\|").replace(/\//gi,"\\/").replace(/'/gi,"\\'").replace(/,/gi,"\\,").replace(/:/gi,"\\:").replace(/\(/gi,"\\(").replace(/\)/gi,"\\)").replace(/\+/gi,"\\+").replace(/\+/gi,"\\-").replace(/\+/gi,"\\_").replace(/\+/gi,"\\%")},PivotViewer.Utils.EscapeItemId=function(e){return e.replace(/\s+/gi,"|").replace(/'/gi,"").replace(/\(/gi,"").replace(/\)/gi,"").replace(/\./gi,"")},PivotViewer.Utils.HtmlSpecialChars=function(e){return jQuery("<div />").text(e).html()},PivotViewer.Utils.Now=function(){return Date.now?Date.now():(new Date).getTime()},PivotViewer.Utils.Min=function(e){var t=1e6;for(var n=0,r=e.length;n<r;n++)t=t>e[n]?e[n]:t;return t},PivotViewer.Utils.Max=function(e){var t=-1e6;for(var n=0,r=e.length;n<r;n++)t=t<e[n]?e[n]:t;return t},PivotViewer.Utils.Histogram=function(e){if(!e instanceof Array)return null;var t=PivotViewer.Utils.Min(e),n=PivotViewer.Utils.Max(e),r=(Math.floor(Math.pow(2*e.length,1/3))+1)*2;r>10&&(r=10);var i=(n+1-(t-1))/r,s=[];for(var o=0;o<r;o++){var u=t+o*i,a=t+(o+1)*i;s.push([]);for(var f=0,l=e.length;f<l;f++)u<=e[f]&&a>e[f]&&s[o].push(e[f])}return{Histogram:s,Min:t,Max:n,BinCount:r}},function(){var e=!1,t=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/;Object.subClass=function(n){function o(){!e&&this.init&&this.init.apply(this,arguments)}var r=this.prototype;e=!0;var i=new this;e=!1;for(var s in n)i[s]=typeof n[s]=="function"&&typeof r[s]=="function"&&t.test(n[s])?function(e,t){return function(){var n=this._super;this._super=r[e];var i=t.apply(this,arguments);return this._super=n,i}}(s,n[s]):n[s];return o.prototype=i,o.constructor=o,o.subClass=arguments.callee,o}}(),PivotViewer.Models.Collection=Object.subClass({init:function(){var e="http://schemas.microsoft.com/collection/metadata/2009",t="http://schemas.microsoft.com/livelabs/pivot/collection/2009";this.CollectionName="",this.BrandImage="",this.FacetCategories=[],this.Items=[],this.CXMLBase="",this.ImageBase="",this.CopyrightName="",this.CopyrightHref="",this.MaxRelatedLinks=0},GetItemById:function(e){for(var t=0;t<this.Items.length;t++)if(this.Items[t].Id==e)return this.Items[t];return null},GetFacetCategoryByName:function(e){for(var t=0;t<this.FacetCategories.length;t++)if(this.FacetCategories[t].Name==e)return this.FacetCategories[t];return null}}),PivotViewer.Models.FacetCategory=Object.subClass({init:function(e,t,n,r,i,s,o){this.Name=e,this.Format=t,this.Type=n!=null&&n!=undefined?n:PivotViewer.Models.FacetType.String,this.IsFilterVisible=r!=null&&r!=undefined?r:!0,this.IsMetaDataVisible=i!=null&&i!=undefined?i:!0,this.IsWordWheelVisible=s!=null&&s!=undefined?s:!0,this.CustomSort}}),PivotViewer.Models.FacetCategorySort=Object.subClass({init:function(e){this.Name=e,this.SortValues=[]}}),PivotViewer.Models.Item=Object.subClass({init:function(e,t,n,r){this.Img=parseInt(e),this.Id=t,this.Href=n,this.Name=r,this.Description,this.Facets=[],this.Links=[]}}),PivotViewer.Models.ItemLink=Object.subClass({init:function(e,t){this.Name=e,this.Href=t}}),PivotViewer.Models.Facet=Object.subClass({init:function(e){this.Name=e,this.FacetValues=[]},AddFacetValue:function(e){this.FacetValues.push(e)}}),PivotViewer.Models.FacetValue=Object.subClass({init:function(e){this.Value=e,this.Href=""}}),PivotViewer.Models.FacetType={String:"String",LongString:"LongString",Number:"Number",DateTime:"DateTime",Link:"Link"},PivotViewer.Models.Loaders.ICollectionLoader=Object.subClass({init:function(){},LoadCollection:function(e){if(!e instanceof PivotViewer.Models.Collection)throw"collection not an instance of PivotViewer.Models.Collection."}}),PivotViewer.Models.Loaders.CXMLLoader=PivotViewer.Models.Loaders.ICollectionLoader.subClass({init:function(e,t){this.CXMLUriNoProxy=e,t?this.CXMLUri=t+e:this.CXMLUri=e},LoadCollection:function(e){var e=e;this._super(e),e.CXMLBaseNoProxy=this.CXMLUriNoProxy,e.CXMLBase=this.CXMLUri,$.ajax({type:"GET",url:this.CXMLUri,dataType:"xml",success:function(t){Debug.Log("CXML loaded");var n=$(t).find("Collection")[0],r=0,i="P";if(n==undefined){$(".pv-loading").remove();var s="";s+="Error parsing CXML Collection<br>",s+="<br>Pivot Viewer cannot continue until this problem is resolved<br>",$(".pv-wrapper").append('<div id="pv-parse-error" class="pv-modal-dialog"><div><a href="#pv-modal-dialog-close" title="Close" class="pv-modal-dialog-close">X</a><h2>HTML5 PivotViewer</h2><p>'+s+"</p></div></div>");var o=setTimeout(function(){window.open("#pv-parse-error","_self")},1e3);throw"Error parsing CXML Collection"}for(var u=0;u<n.attributes.length;u++)if(n.attributes[u].value=="http://schemas.microsoft.com/livelabs/pivot/collection/2009"){i=n.attributes[u].localName!=undefined?n.attributes[u].localName:n.attributes[u].baseName;break}e.CollectionName=$(n).attr("Name"),e.BrandImage=$(n).attr(i+":BrandImage")!=undefined?$(n).attr(i+":BrandImage"):"";var a=$(t).find("FacetCategory");for(var u=0;u<a.length;u++){var f=$(a[u]),l=new PivotViewer.Models.FacetCategory(f.attr("Name"),f.attr("Format"),f.attr("Type"),f.attr(i+":IsFilterVisible")!=undefined?f.attr(i+":IsFilterVisible").toLowerCase()=="true"?!0:!1:!0,f.attr(i+":IsMetaDataVisible")!=undefined?f.attr(i+":IsMetaDataVisible").toLowerCase()=="true"?!0:!1:!0,f.attr(i+":IsWordWheelVisible")!=undefined?f.attr(i+":IsWordWheelVisible").toLowerCase()=="true"?!0:!1:!0),c=f.find(i+"\\:SortOrder"),h=c.find(i+"\\:SortValue");c.length==0&&(c=f.find("SortOrder"),h=c.find("SortValue"));if(c.length==1){var p=new PivotViewer.Models.FacetCategorySort(c.attr("Name"));for(var d=0;d<h.length;d++)p.SortValues.push($(h[d]).attr("Value"));l.CustomSort=p}e.FacetCategories.push(l)}var v=$(t).find("Items");if(v.length==1){e.ImageBase=$(v[0]).attr("ImgBase");var m=$(v[0]).find("Item");if(m.length==0){$(".pv-loading").remove();var s="";s+="There are no items in the CXML Collection<br><br>",$(".pv-wrapper").append('<div id="pv-empty-collection-error" class="pv-modal-dialog"><div><a href="#pv-modal-dialog-close" title="Close" class="pv-modal-dialog-close">X</a><h2>HTML5 PivotViewer</h2><p>'+s+"</p></div></div>");var o=setTimeout(function(){window.open("#pv-empty-collection-error","_self")},1e3)}else for(var u=0;u<m.length;u++){var g=new PivotViewer.Models.Item($(m[u]).attr("Img").replace("#",""),$(m[u]).attr("Id"),$(m[u]).attr("Href"),$(m[u]).attr("Name")),y=$(m[u]).find("Description");y.length==1&&y[0].childNodes.length&&(g.Description=PivotViewer.Utils.HtmlSpecialChars(y[0].childNodes[0].nodeValue));var b=$(m[u]).find("Facet");for(var d=0;d<b.length;d++){var w=new PivotViewer.Models.Facet($(b[d]).attr("Name")),E=$(b[d]).children();for(var S=0;S<E.length;S++)if(E[S].nodeType==1){var T=$.trim($(E[S]).attr("Value"));if(T==null||T=="")if(E[S].nodeName=="Link")if($(E[S]).attr("Href")==""||$(E[S]).attr("Href")==null){var N=new PivotViewer.Models.FacetValue(PivotViewer.Utils.HtmlSpecialChars("(empty Link)"));w.AddFacetValue(N)}else if($(E[S]).attr("Name")==""||$(E[S]).attr("Name")==null){var N=new PivotViewer.Models.FacetValue("(unnamed Link)");N.Href=$(E[S]).attr("Href"),w.AddFacetValue(N)}else{var N=new PivotViewer.Models.FacetValue($(E[S]).attr("Name"));N.Href=$(E[S]).attr("Href"),w.AddFacetValue(N)}else{var N=new PivotViewer.Models.FacetValue(PivotViewer.Utils.HtmlSpecialChars("(empty "+E[S].nodeName+")"));w.AddFacetValue(N)}else if(E[S].nodeName=="Number"){var N=new PivotViewer.Models.FacetValue(parseFloat(T));w.AddFacetValue(N)}else{var N=new PivotViewer.Models.FacetValue(PivotViewer.Utils.HtmlSpecialChars(T));w.AddFacetValue(N)}}g.Facets.push(w)}var C=$(m[u]).find("Extension");if(C.length==1){var k=$(C[0]).find("d1p1\\:Related, Related");if(k.length==1){var L=$(k[0]).find("d1p1\\:Link, Link");for(var A=0;A<L.length;A++){var O=$(L[A]).attr("Name"),M=$(L[A]).attr("Href");if(M.indexOf(".cxml")==-1&&M.indexOf("pivot.vsp")>=0){var _=$.url(this.url);M=_.attr("protocol")+"://"+_.attr("authority")+_.attr("directory")+M}var D=new PivotViewer.Models.ItemLink(O,M);g.Links.push(D)}L.length>r&&(r=L.length)}}e.Items.push(g)}}e.MaxRelatedLinks=r;var P=$(t).find("Extension");if(P.length>1)for(x=0;x<P.length;x++){var H=$(P[x]).find("d1p1\\:Copyright, Copyright");if(H.length>0){e.CopyrightName=$(H[0]).attr("Name"),e.CopyrightHref=$(H[0]).attr("Href");break}}$.publish("/PivotViewer/Models/Collection/Loaded",null)},error:function(e,t,n){$(".pv-loading").remove();var r="";r+="Error loading CXML Collection<br><br>",r=r+"URL        : "+this.url+"<br>",r=r+"Status : "+e.status+" "+n+"<br>",r=r+"Details    : "+e.responseText+"<br>",r+="<br>Pivot Viewer cannot continue until this problem is resolved<br>",$(".pv-wrapper").append('<div id="pv-loading-error" class="pv-modal-dialog"><div><a href="#pv-modal-dialog-close" title="Close" class="pv-modal-dialog-close">X</a><h2>HTML5 PivotViewer</h2><p>'+r+"</p></div></div>");var i=setTimeout(function(){window.open("#pv-loading-error","_self")},1e3)}})}}),PivotViewer.Views.IPivotViewerView=Object.subClass({init:function(){this.isActive=!1,this.init=!0,this.selected="",this.tiles=[]},Setup:function(e,t,n,r,i){},Filter:function(e,t,n){},GetUI:function(){return""},GetButtonImage:function(){return""},GetButtonImageSelected:function(){return""},GetViewName:function(){return""},Activate:function(){this.isActive=!0},Deactivate:function(){this.isActive=!1}}),PivotViewer.Views.TileBasedView=PivotViewer.Views.IPivotViewerView.subClass({OffsetTiles:function(e,t){for(var n=0;n<this.tiles.length;n++){var r=$.inArray(this.tiles[n].facetItem.Id,this.currentFilter);r>=0&&(this.tiles[n]._locations[0].destinationx+=e,this.tiles[n]._locations[0].destinationy+=t)}},SetInitialTiles:function(e,t,n){var r=t/2,i=n/2;for(var s=0;s<e.length;s++)e[s]._locations[0].x=r,e[s]._locations[0].y=i,e[s].velocityx=0,e[s].velocityy=0,e[s]._locations[0].startx=r,e[s]._locations[0].starty=i,e[s]._locations[0].destinationx=0,e[s]._locations[0].destinationy=0,e[s].width=1,e[s].height=1},GetRowsAndColumns:function(e,t,n,r){var i=.7,s=n*(r-Math.pow(i,2)),o=(t+e*n)*i,u=-1*t*e,a=(-1*o+Math.sqrt(Math.pow(o,2)-4*s*u))/(2*s),f=Math.floor(a*n),l=Math.ceil(t/f),c=Math.floor(e/a),h=e-c*a;return{Rows:l,Columns:c,TileMaxWidth:a,TileHeight:f,PaddingX:h}},SetOuterTileDestination:function(e,t,n){var r=n._locations[0].x-e/2,i=n._locations[0].y-t/2,s=i/r,o=Math.atan2(i,r);n._locations[0].destinationx=e*Math.cos(o)+e/2,n._locations[0].destinationy=t*Math.sin(o)+t/2},SortBy:function(e,t,n,r){var i=function(t,r){if(n)for(var i=t.facetItem.Facets.length-1;i>-1;i-=1)if(t.facetItem.Facets[i].Name==e&&t.facetItem.Facets[i].FacetValues.length>0){if($.isNumeric(t.facetItem.Facets[i].FacetValues[0].Value))return n(t.facetItem.Facets[i].FacetValues[0].Value);for(var s=0;s<t.facetItem.Facets[i].FacetValues.length;s++)if(r.length>0)for(var o=0;o<r.length;o++)if(r[o].facet==e)for(var u=0;u<r[o].facetValue.length;u++)if(t.facetItem.Facets[i].FacetValues[s].Value==r[o].facetValue[u])return n(t.facetItem.Facets[i].FacetValues[s].Value);return n(t.facetItem.Facets[i].FacetValues[0].Value)}return null};return function(e,n){var s=i(e,r),o=i(n,r);return(s<o?-1:s>o?1:0)*[1,-1][+!!t]}}}),PivotViewer.Views.GridView=PivotViewer.Views.TileBasedView.subClass({init:function(){this.Scale=1,this._super(),this.dontZoom=!1;var e=this;$.subscribe("/PivotViewer/Views/Canvas/Click",function(t){if(!e.isActive)return;var n=null,r=null;for(var i=0;i<e.tiles.length;i++){var s=e.tiles[i].Contains(t.x,t.y);s>=0?(r=e.tiles[i],n=e.tiles[i].facetItem.Id):e.tiles[i].Selected(!1)}e.handleSelection(n,r)}),$.subscribe("/PivotViewer/Views/Canvas/Hover",function(t){if(!e.isActive||e.selected.length>0)return;for(var n=0;n<e.tiles.length;n++){var r=e.tiles[n].Contains(t.x,t.y);r>=0?e.tiles[n].Selected(!0):e.tiles[n].Selected(!1)}}),$.subscribe("/PivotViewer/Views/Canvas/Zoom",function(t){if(!e.isActive)return;if(e.dontZoom){e.dontZoom=!1;return}var n=e.Scale,r=e.currentWidth,i=e.currentHeight,s=t.scale!=undefined?0:1e3;t.scale!=undefined?t.scale>=1?e.Scale+=t.scale-1:(e.Scale-=t.scale,e.Scale=e.Scale<1?1:e.Scale):t.delta!=undefined&&(e.Scale=t.delta==0?1:e.Scale+t.delta-1),e.Scale==NaN&&(e.Scale=1);var o=(e.width-e.offsetX)*e.Scale,u=(e.height-e.offsetY)*e.Scale;if(o<e.width||e.Scale==1)e.currentOffsetX=e.offsetX,e.currentOffsetY=e.offsetY,e.currentWidth=e.width,e.currentHeight=e.height,e.Scale=1,e.dontZoom=!0,$(".pv-toolbarpanel-zoomslider").slider("option","value",0);else{var a=(t.x-e.currentOffsetX)/n*e.Scale,f=(t.y-e.currentOffsetY)/n*e.Scale;e.currentOffsetX=t.x-a,e.currentOffsetY=t.y-f,e.currentWidth=o,e.currentHeight=u}var l=e.GetRowsAndColumns(e.currentWidth-e.offsetX,e.currentHeight-e.offsetY,e.maxRatio,e.currentFilter.length);e.SetVisibleTilePositions(l,e.currentFilter,e.currentOffsetX,e.currentOffsetY,!0,!0,s);if(e.Scale==1&&n!=1){for(var c=0;c<e.tiles.length;c++)e.tiles[c].Selected(!1);e.selected="",$.publish("/PivotViewer/Views/Item/Selected",[{id:e.selected,bkt:0}])}}),$.subscribe("/PivotViewer/Views/Canvas/Drag",function(t){if(!e.isActive)return;var n=t.x,r=t.y,i=!1,s=!1;e.currentOffsetX+=n,e.currentOffsetY+=r,n>0&&e.currentOffsetX>e.offsetX&&(e.currentOffsetX-=n,i=!0),r>0&&e.currentOffsetY>e.offsetY&&(e.currentOffsetY-=r,s=!0),e.currentOffsetX<e.offsetX&&e.currentWidth==e.width&&(e.currentOffsetX-=n,i=!0),n<0&&e.currentOffsetX<-1*(e.currentWidth-e.width)&&(e.currentOffsetX-=n,i=!0),e.currentOffsetY<e.offsetY&&e.currentHeight==e.height&&(e.currentOffsetY-=r,s=!0),r<0&&e.currentOffsetY-e.offsetY<-1*(e.currentHeight-e.height)&&(e.currentOffsetY-=r,s=!0);if(i&&s)return;i?e.OffsetTiles(0,r):s?e.OffsetTiles(n,0):e.OffsetTiles(n,r)})},Setup:function(e,t,n,r,i){this.width=e,this.height=t,this.offsetX=n,this.offsetY=r,this.maxRatio=i,this.currentWidth=this.width,this.currentHeight=this.height,this.currentOffsetX=this.offsetX,this.currentOffsetY=this.offsetY},Filter:function(e,t,n,r,i,s){var o=this,u=!1;if(!Modernizr.canvas)return;Debug.Log("Grid View Filtered: "+t.length),this.changingView=!1,i&&($(".pv-tableview-table").is(":visible")&&(u=!0,$(".pv-tableview-table").fadeOut(),this.selected="",$(".pv-toolbarpanel-zoomslider").fadeIn(),$(".pv-toolbarpanel-zoomcontrols").css("border-width","1px"),$(".pv-viewarea-canvas").fadeIn(function(){$.publish("/PivotViewer/Views/ChangeTo/Grid",[{Item:s}])})),$(".pv-mapview-canvas").is(":visible")&&(u=!0,$(".pv-mapview-canvas").fadeOut(),this.selected="",$(".pv-toolbarpanel-zoomslider").fadeIn(),$(".pv-toolbarpanel-zoomcontrols").css("border-width","1px"),$(".pv-viewarea-canvas").fadeIn(function(){$.publish("/PivotViewer/Views/ChangeTo/Grid",[{Item:s}])}))),this.tiles=e,this.init&&this.SetInitialTiles(this.tiles,this.width,this.height);for(var a=0;a<this.tiles.length;a++)while(this.tiles[a]._locations.length>1)this.tiles[a]._locations.pop();for(var f=0;f<this.tiles.length;f++)this.tiles[f].selectedLoc=0;this.tiles=this.tiles.sort(this.SortBy(n,!1,function(e){return $.isNumeric(e)?e:e.toUpperCase()},r)),this.currentFilter=t;if(!u||s==""){var l=0;Debug.Log("this.currentWidth: "+this.currentWidth+" this.width: "+this.width);var c=$(".pv-toolbarpanel-zoomslider").slider("option","value");if(c>0){this.selected=selectedItem="",this.currentOffsetX=this.offsetX,this.currentOffsetY=this.offsetY,$(".pv-toolbarpanel-zoomslider").slider("option","value",1);var h=this.GetRowsAndColumns(this.currentWidth-this.offsetX,this.currentHeight-this.offsetY,this.maxRatio,this.tiles.length),p=[];for(var f=0;f<this.tiles.length;f++)this.tiles[f].origwidth=h.TileHeight/this.tiles[f]._controller.GetRatio(this.tiles[f].facetItem.Img),this.tiles[f].origheight=h.TileHeight,p.push(this.tiles[f].facetItem.Id);this.SetVisibleTilePositions(h,p,this.currentOffsetX,this.currentOffsetY,!0,!1,1e3),l=1e3}setTimeout(function(){for(var e=0;e<o.tiles.length;e++){o.tiles[e]._locations[0].startx=o.tiles[e]._locations[0].x,o.tiles[e]._locations[0].starty=o.tiles[e]._locations[0].y,o.tiles[e].startwidth=o.tiles[e].width,o.tiles[e].startheight=o.tiles[e].height;var n=$.inArray(o.tiles[e].facetItem.Id,t);n<0&&(o.SetOuterTileDestination(o.width,o.height,o.tiles[e]),o.tiles[e].start=PivotViewer.Utils.Now(),o.tiles[e].end=o.tiles[e].start+1e3)}o.maxRatio=o.tiles[0]._controller.GetRatio(o.tiles[0].facetItem.Img);for(var e=0;e<o.tiles.length;e++){var n=$.inArray(o.tiles[e].facetItem.Id,t);n>=0&&o.tiles[e]._controller.GetRatio(o.tiles[e].facetItem.Img)<o.maxRatio&&(o.maxRatio=o.tiles[e]._controller.GetRatio(o.tiles[e].facetItem.Img))}var r=t.length==o.tiles.length?0:500;setTimeout(function(){var e=o.GetRowsAndColumns(o.width-o.offsetX,o.height-o.offsetY,o.maxRatio,o.currentFilter.length);for(var t=0;t<o.tiles.length;t++)o.tiles[t].origwidth=e.TileHeight/o.tiles[t]._controller.GetRatio(o.tiles[t].facetItem.Img),o.tiles[t].origheight=e.TileHeight;o.SetVisibleTilePositions(e,o.currentFilter,o.offsetX,o.offsetY,!1,!1,1e3)},r)},l)}this.init=!1},GetUI:function(){return Modernizr.canvas?"":"<div class='pv-viewpanel-unabletodisplay'><h2>Unfortunately this view is unavailable as your browser does not support this functionality.</h2>Please try again with one of the following supported browsers: IE 9+, Chrome 4+, Firefox 2+, Safari 3.1+, iOS Safari 3.2+, Opera 9+<br/><a href='http://caniuse.com/#feat=canvas'>http://caniuse.com/#feat=canvas</a></div>"},GetButtonImage:function(){return"Content/images/GridView.png"},GetButtonImageSelected:function(){return"Content/images/GridViewSelected.png"},GetViewName:function(){return"Grid View"},SetVisibleTilePositions:function(e,t,n,r,i,s,o){var u=s&&this.rowscols?this.rowscols.Columns:e.Columns;s||(this.rowscols=e);var a=0,f=0;for(var l=0;l<this.tiles.length;l++){var c=$.inArray(this.tiles[l].facetItem.Id,t);c>=0&&(i&&(this.tiles[l]._locations[0].startx=this.tiles[l]._locations[0].x,this.tiles[l]._locations[0].starty=this.tiles[l]._locations[0].y,this.tiles[l].startwidth=this.tiles[l].width,this.tiles[l].startheight=this.tiles[l].height),this.tiles[l].destinationwidth=e.TileMaxWidth,this.tiles[l].destinationheight=e.TileHeight,this.tiles[l]._locations[0].destinationx=a*e.TileMaxWidth+n,this.tiles[l]._locations[0].destinationy=f*e.TileHeight+r,this.tiles[l].start=PivotViewer.Utils.Now(),this.tiles[l].end=this.tiles[l].start+o,a==u-1?(a=0,f++):a++)}},GetSelectedCol:function(e){var t=this;return selectedCol=Math.round((e._locations[0].x-t.currentOffsetX)/e.width),selectedCol},GetSelectedRow:function(e){var t=this;return selectedRow=Math.round((e._locations[0].y-t.currentOffsetY)/e.height),selectedRow},CentreOnSelectedTile:function(e,t){var n=this,r;for(var i=0;i<n.tiles.length;i++)if(n.tiles[i].IsSelected()){r=n.tiles[i];break}var s=n.GetRowsAndColumns(n.currentWidth-n.offsetX,n.currentHeight-n.offsetY,n.maxRatio,n.currentFilter.length);n.currentOffsetX=s.TileMaxWidth*e*-1+n.width/2-s.TileMaxWidth/2,n.currentOffsetY=s.TileHeight*t*-1+n.height/2-s.TileHeight/2,n.SetVisibleTilePositions(s,n.currentFilter,n.currentOffsetX,n.currentOffsetY,!0,!0,1e3)},handleSelection:function(e,t){var n=this,r=0,i=0,s=0,o=0;e!=null&&t!=null&&(r=Math.round((t._locations[0].x-n.currentOffsetX)/t.width),i=Math.round((t._locations[0].y-n.currentOffsetY)/t.height));if(e!=null&&n.selected!=e&&n.selected==""){var u=$(".pv-toolbarpanel-zoomslider").slider("option","value");u!=0&&$(".pv-toolbarpanel-zoomslider").slider("option","value",0)}e!=null&&t!=null&&(t.Selected(!0),tileHeight=t.height,tileWidth=t.height/t._controller.GetRatio(t.facetItem.Img),tileOrigHeight=t.origheight,tileOrigWidth=t.origwidth,canvasHeight=t.context.canvas.height,canvasWidth=t.context.canvas.width-($(".pv-filterpanel").width()+$(".pv-infopanel").width()));if(e!=null&&n.selected!=e){tileHeight/canvasHeight>tileWidth/canvasWidth?origProportion=tileOrigHeight/canvasHeight:origProportion=tileOrigWidth/canvasWidth,scale=Math.round(.75/origProportion*2);if(n.selected==""){var u=$(".pv-toolbarpanel-zoomslider").slider("option","value");u=scale,$(".pv-toolbarpanel-zoomslider").slider("option","value",u)}n.selected=e,n.CentreOnSelectedTile(r,i)}else{n.selected=e="",n.currentOffsetX=n.offsetX,n.currentOffsetY=n.offsetY;var u=$(".pv-toolbarpanel-zoomslider").slider("option","value");u=0,$(".pv-toolbarpanel-zoomslider").slider("option","value",u)}$.publish("/PivotViewer/Views/Item/Selected",[{id:e,bkt:0}])}}),PivotViewer.Views.GraphView=PivotViewer.Views.TileBasedView.subClass({init:function(){this._super();var e=this;this.buckets=[],this.Scale=1,this.canvasHeightUIAdjusted=0,this.titleSpace=62,this.dontZoom=!1,$.subscribe("/PivotViewer/Views/Canvas/Click",function(t){if(!e.isActive)return;var n=null,r=null,i=null;for(var s=0;s<e.tiles.length;s++){var o=e.tiles[s].Contains(t.x,t.y);o>=0?(r=e.tiles[s],n=e.tiles[s].facetItem.Id,i=o):e.tiles[s].Selected(!1)}e.handleSelection(n,r,t.x,i)}),$.subscribe("/PivotViewer/Views/Canvas/Hover",function(t){if(!e.isActive)return;$(".pv-viewarea-graphview-overlay-bucket").removeClass("graphview-bucket-hover");var n=Math.floor((t.x-e.offsetX)/e.columnWidth),r=$("#pv-viewarea-graphview-overlay-bucket-"+n);r.addClass("graphview-bucket-hover");for(var i=0;i<e.tiles.length;i++){var s=e.tiles[i].Contains(t.x,t.y);s>=0?(e.tiles[i].Selected(!0),e.tiles[i].selectedLoc=s):e.tiles[i].Selected(!1)}}),$.subscribe("/PivotViewer/Views/Canvas/Zoom",function(t){if(!e.isActive)return;if(e.dontZoom){e.dontZoom=!1;return}var n=e.Scale,r=e.currentWidth,i=e.currentHeight,s=t.scale!=undefined?0:1e3;t.scale!=undefined?t.scale>=1?e.Scale+=t.scale-1:(e.Scale-=t.scale,e.Scale=e.Scale<1?1:e.Scale):t.delta!=undefined&&(e.Scale=t.delta==0?1:e.Scale+t.delta-1),e.Scale==NaN&&(e.Scale=1);var o=(e.width-e.offsetX)*e.Scale,u=e.height*e.Scale;if(o<e.width||e.Scale==1)e.currentOffsetX=e.offsetX,e.currentOffsetY=e.offsetY,e.currentWidth=e.width,e.currentHeight=e.height,e.canvasHeightUIAdjusted=e.height-e.offsetY-e.titleSpace,e.columnWidth=(e.width-e.offsetX)/e.buckets.length,e.Scale=1,$(".pv-viewarea-graphview-overlay div").fadeIn("slow"),e.dontZoom=!0,$(".pv-toolbarpanel-zoomslider").slider("option","value",0);else{e.currentOffsetX=t.x-(t.x-e.currentOffsetX)/n*e.Scale;var a=(t.y-e.currentOffsetY)/n*e.Scale;e.currentOffsetY=t.y-a,e.canvasHeightUIAdjusted=u-(e.offsetY+e.titleSpace)/n*e.Scale,e.currentWidth=o,e.currentHeight=u,e.columnWidth=o/e.buckets.length,$(".pv-viewarea-graphview-overlay div").fadeOut("slow")}e.rowscols=e.GetRowsAndColumns(e.columnWidth-2,e.canvasHeightUIAdjusted,e.maxRatio,e.bigCount),e.rowscols.TileHeight<10&&(e.rowscols.TileHeight=10),e.SetVisibleTileGraphPositions(e.rowscols,e.currentOffsetX,e.currentOffsetY,!0,!0);if(e.Scale==1&&n!=1){for(var f=0;f<e.tiles.length;f++)e.tiles[f].Selected(!1),e.tiles[f].selectedLoc=0;e.selected="",$.publish("/PivotViewer/Views/Item/Selected",[{id:e.selected,bkt:0}])}}),$.subscribe("/PivotViewer/Views/Canvas/Drag",function(t){if(!e.isActive)return;var n=t.x,r=t.y,i=!1,s=!1;e.currentOffsetX+=n,e.currentOffsetY+=r,n>0&&e.currentOffsetX>e.offsetX&&(e.currentOffsetX-=n,i=!0),r>0&&e.currentOffsetY+e.canvasHeightUIAdjusted>e.currentHeight+e.offsetY&&(e.currentOffsetY-=r,s=!0),e.currentOffsetX<e.offsetX&&e.currentWidth==e.width&&(e.currentOffsetX-=n,i=!0),n<0&&e.currentOffsetX<-1*(e.currentWidth-e.width)&&(e.currentOffsetX-=n,i=!0),e.currentOffsetY<e.offsetY&&e.currentHeight==e.height&&(e.currentOffsetY-=r,s=!0),r<0&&e.currentOffsetY-e.offsetY<-1*(e.currentHeight-e.height)&&(e.currentOffsetY-=r,s=!0);if(i&&s)return;i?e.OffsetTiles(0,r):s?e.OffsetTiles(n,0):e.OffsetTiles(n,r)})},Setup:function(e,t,n,r,i){this.width=e,this.height=t,this.offsetX=n,this.offsetY=r,this.maxRatio=i,this.currentWidth=this.width,this.currentHeight=this.height,this.currentOffsetX=this.offsetX,this.currentOffsetY=this.offsetY,this.rowscols=null,this.bigCount=0},Filter:function(e,t,n,r,i,s){var o=this;if(!Modernizr.canvas)return;Debug.Log("Graph View Filtered: "+t.length),this.changingView=!1,i&&($(".pv-tableview-table").is(":visible")&&($(".pv-tableview-table").fadeOut(),$(".pv-toolbarpanel-zoomslider").fadeIn(),$(".pv-toolbarpanel-zoomcontrols").css("border-width","1px"),$(".pv-viewarea-canvas").fadeIn()),$(".pv-mapview-canvas").is(":visible")&&($(".pv-mapview-canvas").fadeOut(),$(".pv-toolbarpanel-zoomslider").fadeIn(),$(".pv-toolbarpanel-zoomcontrols").css("border-width","1px"),$(".pv-viewarea-canvas").fadeIn())),this.sortFacet=n,this.tiles=e,this.tiles=e.sort(this.SortBy(this.sortFacet,!1,function(e){return $.isNumeric(e)?e:e.toUpperCase()},r)),this.currentFilter=t,this.buckets=this.Bucketize(e,t,this.sortFacet,r),this.columnWidth=(this.width-this.offsetX)/this.buckets.length,this.canvasHeightUIAdjusted=this.height-this.offsetY-this.titleSpace;var u=[];this.bigCount=0;for(var a=0;a<this.buckets.length;a++){var f=a%2==0?"graphview-bucket-dark":"graphview-bucket-light";u[a]="<div class='pv-viewarea-graphview-overlay-bucket "+f+"' id='pv-viewarea-graphview-overlay-bucket-"+a+"' style='width: "+(Math.floor(this.columnWidth)-4)+"px; height:"+(this.height-2)+"px; left:"+(a*this.columnWidth-2)+"px;'>",this.buckets[a].startRange==this.buckets[a].endRange?u[a]+="<div class='pv-viewarea-graphview-overlay-buckettitle' style='top: "+(this.canvasHeightUIAdjusted+4)+"px;'>"+this.buckets[a].startRange+"</div></div>":u[a]+="<div class='pv-viewarea-graphview-overlay-buckettitle' style='top: "+(this.canvasHeightUIAdjusted+4)+"px;'>"+this.buckets[a].startRange+"<br/>to<br/>"+this.buckets[a].endRange+"</div></div>",this.bigCount<this.buckets[a].Ids.length&&(this.bigCount=this.buckets[a].Ids.length)}var l=$(".pv-viewarea-graphview-overlay");l.css("left",this.offsetX+"px"),$(".pv-viewarea-graphview-overlay div").fadeOut("slow",function(){$(this).remove()}),l.append(u.join("")),$(".pv-viewarea-graphview-overlay div").fadeIn("slow");for(var a=0;a<this.tiles.length;a++){this.tiles[a]._locations[0].startx=this.tiles[a]._locations[0].x,this.tiles[a]._locations[0].starty=this.tiles[a]._locations[0].y,this.tiles[a].startwidth=this.tiles[a].width,this.tiles[a].startheight=this.tiles[a].height;var c=$.inArray(this.tiles[a].facetItem.Id,t);c<0&&(this.SetOuterTileDestination(this.width,this.height,this.tiles[a]),this.tiles[a].start=PivotViewer.Utils.Now(),this.tiles[a].end=this.tiles[a].start+1e3)}o.maxRatio=o.tiles[0]._controller.GetRatio(o.tiles[0].facetItem.Img);for(var a=0;a<o.tiles.length;a++){var c=$.inArray(o.tiles[a].facetItem.Id,t);c>=0&&o.tiles[a]._controller.GetRatio(o.tiles[a].facetItem.Img)<o.maxRatio&&(o.maxRatio=o.tiles[a]._controller.GetRatio(o.tiles[a].facetItem.Img))}var h=t.length==this.tiles.length?0:500;setTimeout(function(){var e=$(".pv-toolbarpanel-zoomslider").slider("option","value");e>0&&(this.selected=selectedItem="",this.currentOffsetX=this.offsetX,this.currentOffsetY=this.offsetY,$(".pv-toolbarpanel-zoomslider").slider("option","value",1)),o.rowscols=o.GetRowsAndColumns(o.columnWidth-2,o.canvasHeightUIAdjusted-o.offsetY,o.maxRatio,o.bigCount),o.rowscols.TileHeight<10&&(o.rowscols.TileHeight=10);for(var t=0;t<o.tiles.length;t++)o.tiles[t].origwidth=o.rowscols.TileHeight/o.tiles[t]._controller.GetRatio(o.tiles[t].facetItem.Img),o.tiles[t].origheight=o.rowscols.TileHeight;o.SetVisibleTileGraphPositions(o.rowscols,o.offsetX,o.offsetY,!1,!1)},h),this.init=!1},GetUI:function(){return Modernizr.canvas?"<div class='pv-viewarea-graphview-overlay'></div>":"<div class='pv-viewpanel-unabletodisplay'><h2>Unfortunately this view is unavailable as your browser does not support this functionality.</h2>Please try again with one of the following supported browsers: IE 9+, Chrome 4+, Firefox 2+, Safari 3.1+, iOS Safari 3.2+, Opera 9+<br/><a href='http://caniuse.com/#feat=canvas'>http://caniuse.com/#feat=canvas</a></div>"},GetButtonImage:function(){return"Content/images/GraphView.png"},GetButtonImageSelected:function(){return"Content/images/GraphViewSelected.png"},GetViewName:function(){return"Graph View"},GetSortedFilter:function(){var e=[];for(i=0;i<this.buckets.length;i++)for(j=0;j<this.buckets[i].Ids.length;j++){var t=new Object;t.Id=this.buckets[i].Ids[j],t.Bucket=i,e.push(t)}return e},SetVisibleTileGraphPositions:function(e,t,n,r,i){var s=i&&this.rowscols?this.rowscols.Columns:e.Columns;i||(this.rowscols=e);var o=[],u=[];for(var a=0;a<this.tiles.length;a++){this.tiles[a].firstFilterItemDone=!1;while(this.tiles[a]._locations.length>1)this.tiles[a]._locations.pop()}for(var f=0;f<this.buckets.length;f++){var l=0,c=0;for(var h=0,p=this.tiles.length;h<p;h++)$.inArray(this.tiles[h].facetItem.Id,this.buckets[f].Ids)>=0&&(this.tiles[h].firstFilterItemDone?(tileLocation=new PivotViewer.Views.TileLocation,tileLocation.startx=this.tiles[h]._locations[0].startx,tileLocation.starty=this.tiles[h]._locations[0].starty,tileLocation.x=this.tiles[h]._locations[0].x,tileLocation.y=this.tiles[h]._locations[0].y,tileLocation.destinationx=f*this.columnWidth+l*e.TileMaxWidth+t,tileLocation.destinationy=this.canvasHeightUIAdjusted-e.TileHeight-c*e.TileHeight+n,this.tiles[h]._locations.push(tileLocation)):(r&&(this.tiles[h]._locations[0].startx=this.tiles[h]._locations[0].x,this.tiles[h]._locations[0].starty=this.tiles[h]._locations[0].y,this.tiles[h].startwidth=this.tiles[h].width,this.tiles[h].startheight=this.tiles[h].height),this.tiles[h].destinationwidth=e.TileMaxWidth,this.tiles[h].destinationheight=e.TileHeight,this.tiles[h]._locations[0].destinationx=f*this.columnWidth+l*e.TileMaxWidth+t,this.tiles[h]._locations[0].destinationy=this.canvasHeightUIAdjusted-e.TileHeight-c*e.TileHeight+n,this.tiles[h].start=PivotViewer.Utils.Now(),this.tiles[h].end=this.tiles[h].start+1e3,this.tiles[h].firstFilterItemDone=!0),l==s-1?(l=0,c++):l++)}},Bucketize:function(e,t,n,r){var i=[];for(var s=0;s<e.length;s++)if($.inArray(e[s].facetItem.Id,t)>=0){var o=!1;for(var u=0;u<e[s].facetItem.Facets.length;u++)if(e[s].facetItem.Facets[u].Name==n&&e[s].facetItem.Facets[u].FacetValues.length>0)for(var a=0;a<e[s].facetItem.Facets[u].FacetValues.length;a++){var f=e[s].facetItem.Facets[u].FacetValues[a].Value,l=!1;for(var c=0;c<i.length;c++)i[c].startRange==f&&($.inArray(e[s].facetItem.Id,i[c].Ids)<0&&i[c].Ids.push(e[s].facetItem.Id),l=!0);l||i.push({startRange:f,endRange:f,Ids:[e[s].facetItem.Id],Values:[f]}),o=!0}if(!o){var f="(no info)",l=!1;for(var c=0;c<i.length;c++)i[c].startRange==f&&(i[c].Ids.push(e[s].facetItem.Id),i[c].Values.push(f),l=!0);l||i.push({startRange:f,endRange:f,Ids:[e[s].facetItem.Id],Values:[f]})}}if(r.length>0){var h;for(var p=0;p<r.length;p++)if(r[p].facet==n){h=p;break}if(h!=undefined&&h>=0){var d=[],v=r[h].facetValue;for(var m=0;m<i.length;m++){var g=$.inArray(i[m].startRange,v);g>=0&&d.push(i[m])}i=d}}var y=0;while(i.length>8)if(y<i.length-1){i[y].endRange=i[y+1].endRange;for(var s=0;s<i[y+1].Ids.length;s++)$.inArray(i[y+1].Ids[s],i[y].Ids)<0&&i[y].Ids.push(i[y+1].Ids[s]),$.inArray(i[y+1].endRange,i[y].Values)<0&&i[y].Values.push(i[y+1].endRange);i.splice(y+1,1),y++}else y=0;return i},GetSelectedCol:function(e,t){var n=this,r=0;for(i=0;i<t;i++)$.inArray(e.facetItem.Id,this.buckets[i].Ids)>0&&r++;return padding=n.rowscols.PaddingX,colsInBar=n.rowscols.Columns,tileMaxWidth=n.rowscols.TileMaxWidth,selectedBar=Math.floor((e._locations[r].x-n.currentOffsetX)/(tileMaxWidth*colsInBar+padding)),selectedColInBar=Math.round((e._locations[r].x-n.currentOffsetX-selectedBar*(colsInBar*tileMaxWidth+padding))/tileMaxWidth),selectedCol=selectedBar*colsInBar+selectedColInBar,selectedCol},GetSelectedRow:function(e,t){var n=this,r=0;for(i=0;i<t;i++)$.inArray(e.facetItem.Id,this.buckets[i].Ids)>0&&r++;return selectedRow=Math.round((n.canvasHeightUIAdjusted-(e._locations
[r].y-n.currentOffsetY))/e.height),selectedRow},CentreOnSelectedTile:function(e,t){var n=this,r;for(var i=0;i<n.tiles.length;i++)if(n.tiles[i].IsSelected()){r=n.tiles[i];break}n.rowscols=n.GetRowsAndColumns(n.columnWidth-2,n.canvasHeightUIAdjusted,n.maxRatio,n.bigCount),n.rowscols.TileHeight<10&&(n.rowscols.TileHeight=10);var s=Math.floor(e/n.rowscols.Columns),o=n.rowscols.PaddingX*s;n.currentOffsetX=n.rowscols.TileMaxWidth*e*-1+n.width/2-n.rowscols.TileMaxWidth/2-o,n.currentOffsetY=-n.rowscols.TileHeight*(n.rowscols.Rows/2-(t+1))-n.canvasHeightUIAdjusted/2-n.rowscols.TileHeight/2,n.SetVisibleTileGraphPositions(n.rowscols,n.currentOffsetX,n.currentOffsetY,!0,!0)},handleSelection:function(e,t,n,r){var i=this,s=0,o=0,u=!1,a=!1,f=0,l=0;e!=null&&t!=null&&(selectedX=t._locations[r].x,selectedY=t._locations[r].y);if(e!=null&&i.selected!=e&&i.selected==""){var c=$(".pv-toolbarpanel-zoomslider").slider("option","value");c!=0&&$(".pv-toolbarpanel-zoomslider").slider("option","value",0)}e!=null&&t!=null&&(t.Selected(!0),t.selectedLoc=r,u=!0,padding=i.rowscols.PaddingX,colsInBar=i.rowscols.Columns,tileMaxWidth=i.rowscols.TileMaxWidth,selectedBar=Math.floor((t._locations[r].x-i.currentOffsetX)/(t.width*colsInBar+padding)),selectedColInBar=Math.round((t._locations[r].x-i.currentOffsetX-selectedBar*(colsInBar*tileMaxWidth+padding))/tileMaxWidth),s=selectedBar*colsInBar+selectedColInBar,o=Math.round((i.canvasHeightUIAdjusted-(t._locations[r].y-i.currentOffsetY))/t.height),tileHeight=t.height,tileWidth=t.height/t._controller.GetRatio(t.facetItem.Img),tileOrigHeight=t.origheight,tileOrigWidth=t.origwidth,canvasHeight=t.context.canvas.height,canvasWidth=t.context.canvas.width-($(".pv-filterpanel").width()+$(".pv-infopanel").width())),i.selected!=null&&i.selected!=""&&!u&&(a=!0);if(e!=null&&i.selected!=e){tileHeight/canvasHeight>tileWidth/canvasWidth?origProportion=tileOrigHeight/canvasHeight:origProportion=tileOrigWidth/canvasWidth,scale=Math.round(.75/origProportion*2);if(i.selected==""){var c=$(".pv-toolbarpanel-zoomslider").slider("option","value");c=scale,$(".pv-toolbarpanel-zoomslider").slider("option","value",c)}i.selected=e,i.CentreOnSelectedTile(s,o),$(".pv-viewarea-graphview-overlay div").fadeOut("slow")}else{i.selected=e="",selectedBar=0,i.currentOffsetX=i.offsetX,i.currentOffsetY=i.offsetY;var c=$(".pv-toolbarpanel-zoomslider").slider("option","value");c=0,$(".pv-toolbarpanel-zoomslider").slider("option","value",c),$(".pv-viewarea-graphview-overlay div").fadeIn("slow")}$.publish("/PivotViewer/Views/Item/Selected",[{id:e,bkt:selectedBar}]);if(!u&&!a){var h=Math.floor((n-i.offsetX)/i.columnWidth);$.publish("/PivotViewer/Views/Item/Filtered",[{Facet:i.sortFacet,Item:i.buckets[h].startRange,MaxRange:i.buckets[h].endRange,Values:i.buckets[h].Values,ClearFacetFilters:!0}])}}}),PivotViewer.Views.TableView=PivotViewer.Views.IPivotViewerView.subClass({init:function(){this._super();var e=this,t,n="",r="",i="pv-key",s=!0,o=!0,u=!0},Setup:function(e,t,n,r,i){this.width=e,this.height=t,this.offsetX=n,this.offsetY=r,this.currentWidth=this.width,this.currentHeight=this.height,this.currentOffsetX=this.offsetX,this.currentOffsetY=this.offsetY,$(".pv-viewpanel").append("<div style='visibility:hidden;position:relative;' id='pv-table-loader'><img src='Content/images/loading.gif'></img></div>"),$("#pv-table-loader").css("top",this.height/2-33+"px"),$("#pv-table-loader").css("left",this.width/2-43+"px")},Filter:function(e,t,n,r,i,s){var o=this;if(!Modernizr.canvas)return;Debug.Log("Table View Filtered: "+t.length),i&&($(".pv-viewarea-canvas").fadeOut(),$(".pv-mapview-canvas").fadeOut(),$(".pv-toolbarpanel-zoomslider").fadeOut(),$(".pv-toolbarpanel-zoomcontrols").css("border-width","0"),$(".pv-tableview-table").fadeIn(function(){s&&$.publish("/PivotViewer/Views/Item/Selected",[{id:s.Id,bkt:0}])})),this.tiles=e,this.currentFilter=t,this.selectedId="",this.sortReverseEntity=!0,this.sortReverseAttribute=!0,this.sortReverseValue=!0,this.CreateTable(t,this.selectedFacet),this.init=!1},GetUI:function(){return Modernizr.canvas?"":"<div class='pv-viewpanel-unabletodisplay'><h2>Unfortunately this view is unavailable as your browser does not support this functionality.</h2>Please try again with one of the following supported browsers: IE 9+, Chrome 4+, Firefox 2+, Safari 3.1+, iOS Safari 3.2+, Opera 9+<br/><a href='http://caniuse.com/#feat=canvas'>http://caniuse.com/#feat=canvas</a></div>"},GetButtonImage:function(){return"Content/images/TableView.png"},GetButtonImageSelected:function(){return"Content/images/TableViewSelected.png"},GetViewName:function(){return"Table View"},CellClick:function(e,t){Debug.Log("CellClick");if(e=="pv-key"){var n=t[0].textContent.trim(),r=-1;for(var i=0;i<this.tiles.length;i++)if(this.tiles[i].facetItem.Name==n){r=this.tiles[i].facetItem.Id;break}r>=0&&r!=this.selectedId?(this.selectedId=r,$.publish("/PivotViewer/Views/Item/Selected",[{id:r,bkt:0}])):r>=0&&r==this.selectedId&&(this.selectedId="",$.publish("/PivotViewer/Views/Item/Selected",[{id:"",bkt:0}]))}else if(e=="pv-facet"){var s=[];this.selectedId==""||this.selectedId==null?s=this.currentFilter:s[0]=this.selectedId,this.selectedFacet==""||this.selectedFacet==null?(this.selectedFacet=t[1].textContent.trim(),this.CreateTable(s,this.selectedFacet,this.sortKey)):(this.selectedFacet="",this.CreateTable(s,"")),$.publish("/PivotViewer/Views/Item/Updated",null)}else e=="pv-value"&&$.publish("/PivotViewer/Views/Item/Filtered",[{Facet:t[1].textContent.trim(),Item:t[2].textContent.trim(),Values:null,ClearFacetFilters:!0}])},CreateTable:function(e,t,n,r){var i=this,s=$("#pv-table"),o=!1,u=new Array,a=0;s.empty();var f,c;if(t==null||t==""||typeof t==undefined)o=!0;$(".pv-tableview-table").css("height",this.height-12+"px"),$(".pv-tableview-table").css("width",this.width-415+"px"),r?f="Content/images/sort-up.png":f="Content/images/sort-down.png";var h="odd-row",p="<table id='pv-table-data' style='color:#484848;'><tr class='pv-tableview-heading'><th id='pv-key' class='tooltipcustom' title='Sort on item name'>Item";n=="pv-key"&&(p+=" <img style='position:relative;top:"+c+"' src='"+f+"'></img>"),p+="</th><th class='tooltipcustom' id='pv-facet' title='Sort on relation name'>Relation",n=="pv-facet"&&(p+=" <img style='position:relative;top:"+c+"' src='"+f+"'></img>"),p+="</th><th id='pv-value' class='tooltipcustom' title='Sort on value'>Value",n=="pv-value"&&(p+=" <img style='position:relative;top:"+c+"' src='"+f+"'></img>"),p+="</th></tr>";for(var d=0;d<e.length;d++)for(var v=0;v<this.tiles.length;v++)if(this.tiles[v].facetItem.Id==e[d]){var m=this.tiles[v].facetItem.Name;if(o||t=="Description"){var g;n=="pv-key"?g=m:n=="pv-facet"?g="Description":n=="pv-value"&&(g=this.tiles[v].facetItem.Description),this.tiles[v].facetItem.Description&&(this.tiles[v].facetItem.Href?u.push({key:g,value:"<tr class='pv-tableview-"+h+"'><td id='pv-key' class='tooltipinter' title='Toggle item selection' style='color:#009933;cursor:pointer'>"+m+" "+"<a href="+this.tiles[v].facetItem.Href.replace(/'/g,"%27")+" target=\"_blank\"><img style='cursor:default;' id='pv-linkout' title='Follow the link' title='Follow the link' src='Content/images/goout.gif'></img></a></a></td><td id='pv-facet' class='tooltipcustom' title='Show only this relation' style='color:#009933;cursor:pointer'>Description</td><td id='pv-value'>"+this.tiles[v].facetItem.Description+"</td></tr>"}):u.push({key:g,value:"<tr class='pv-tableview-"+h+"'><td id='pv-key' class='tooltip' title='Toggle item selection'>"+m+"</td><td id='pv-facet' class='tooltipcustom' title='Show only this relation' style='color:#009933;cursor:pointer'>Description</td><td id='pv-value'>"+this.tiles[v].facetItem.Description+"</td></tr>"}),h="even-row")}h=="odd-row"?h="even-row":h="odd-row";if(o)for(k=0;k<this.tiles[v].facetItem.Facets.length;k++){var y=this.tiles[v].facetItem.Facets[k].Name;for(l=0;l<this.tiles[v].facetItem.Facets[k].FacetValues.length;l++){var b=this.tiles[v].facetItem.Facets[k].FacetValues[l].Value,g;n=="pv-key"?g=m:n=="pv-facet"?g=y:n=="pv-value"&&(g=b),this.IsFilterVisible(y)?this.tiles[v].facetItem.Href?this.IsUri(b)?u.push({key:g,value:"<tr class='pv-tableview-"+h+"'><td id='pv-key' class='tooltipinter' title='Toggle item selection' style='color:#009933;cursor:pointer'>"+m+" "+"<a href="+this.tiles[v].facetItem.Href.replace(/'/g,"%27")+" target=\"_blank\"><img style='cursor:default;' id='pv-linkout' title='Follow the link' src='Content/images/goout.gif'></img></a></td><td id='pv-facet' class='tooltipcustom'  title='Show only this relation' style='color:#009933;cursor:pointer'>"+y+"</td><td id='pv-value' class='tooltipinter' title='Filter on this value' style='color:#009933;cursor:pointer'>"+b+" "+"<a href="+b+" target=\"_blank\"><img style='cursor:default;' id=pv-linkout' title='Follow the link' src='Content/images/goout.gif'></img></a></td></tr>"}):u.push({key:g,value:"<tr class='pv-tableview-"+h+"'><td id='pv-key' class='tooltipinter' title='Toggle item selection' style='color:#009933;cursor:pointer'>"+m+" "+"<a href="+this.tiles[v].facetItem.Href.replace(/'/g,"%27")+" target=\"_blank\"><img style='cursor:default;' id='pv-linkout' title='Follow the link' src='Content/images/goout.gif'></img></a></td><td id='pv-facet' class='tooltipcustom'  title='Show only this relation' style='color:#009933;cursor:pointer'>"+y+"</td><td id='pv-value' class='tooltipinter' title='Filter on this value' style='color:#009933;cursor:pointer'>"+b+"</td></tr>"}):this.IsUri(b)?u.push({key:g,value:"<tr class='pv-tableview-"+h+"'><td id='pv-key' class='tooltipcustom' title='Toggle item selection'>"+m+"</td><td id='pv-facet' class='tooltipcustom'  title='Show only this relation'> style='color:#009933;cursor:pointer'"+y+"</td><td id='pv-value' class='tooltipinter' title='Filter on this value' style='color:#009933;cursor:pointer'>"+b+" "+"<a href="+b+" target=\"_blank\"><img style='cursor:default;' id=pv-linkout' title='Follow the link' src='Content/images/goout.gif'></img></a></td></tr>"}):u.push({key:g,value:"<tr class='pv-tableview-"+h+"'><td id='pv-key' class='tooltipcustom' title='Toggle item selection'>"+m+"</td><td id='pv-facet' class='tooltipcustom'  title='Show only this relation'> style='color:#009933;cursor:pointer'"+y+"</td><td id='pv-value' class='tooltipinter'  title='Filter on this value' style='color:#009933;cursor:pointer'>"+b+"</td></tr>"}):this.tiles[v].facetItem.Href?this.IsUri(b)?u.push({key:g,value:"<tr class='pv-tableview-"+h+"'><td id='pv-key' class='tooltipinter' title='Toggle item selection' style='color:#009933;cursor:pointer'>"+m+" "+"<a href="+this.tiles[v].facetItem.Href.replace(/'/g,"%27")+" target=\"_blank\"><img style='cursor:default;' id='pv-linkout' title='Follow the link' src='Content/images/goout.gif'></img></a></td><td id='pv-facet' class='tooltipcustom' title='Show only this relation'> style='color:#009933;cursor:pointer'"+y+"</td><td id='pv-value'><a href="+b+">"+b+"</a></td></tr>"}):u.push({key:g,value:"<tr class='pv-tableview-"+h+"'><td id='pv-key' class='tooltipinter' title='Toggle item selection' style='color:#009933;cursor:pointer'>"+m+" "+"<a href="+this.tiles[v].facetItem.Href.replace(/'/g,"%27")+" target=\"_blank\"><img style='cursor:default;' id='pv-linkout' title='Follow the link' src='Content/images/goout.gif'></img></a></td><td id='pv-facet' class='tooltipcustom' title='Show only this relation'> style='color:#009933;cursor:pointer'"+y+"</td><td id='pv-value'>"+b+"</td></tr>"}):this.IsUri(b)?u.push({key:g,value:"<tr class='pv-tableview-"+h+"'><td id='pv-key' class='tooltipcustom' title='Select this value'>"+m+"</td><td id='pv-facet' class='tooltipcustom' title='Show only this relation'> style='color:#009933;cursor:pointer'"+y+"</td><td id='pv-value'><a href"+b+">"+b+"</a></td></tr>"}):u.push({key:g,value:"<tr class='pv-tableview-"+h+"'><td id='pv-key' class='tooltipcustom' title='Select this value'>"+m+"</td><td id='pv-facet' class='tooltipcustom' title='Show only this relation'> style='color:#009933;cursor:pointer'"+y+"</td><td id='pv-value'>"+b+"</td></tr>"}),h=="odd-row"?h="even-row":h="odd-row"}}else for(k=0;k<this.tiles[v].facetItem.Facets.length;k++){var y=this.tiles[v].facetItem.Facets[k].Name;if(y==t){for(l=0;l<this.tiles[v].facetItem.Facets[k].FacetValues.length;l++){var b=this.tiles[v].facetItem.Facets[k].FacetValues[l].Value,g;n=="pv-key"?g=m:n=="pv-facet"?g=y:n=="pv-value"&&(g=b),this.IsFilterVisible(y)?this.tiles[v].facetItem.Href?this.IsUri(b)?u.push({key:g,value:"<tr class='pv-tableview-"+h+"'><td id='pv-key' class='tooltipinter' title='Toggle item selection' style='color:#009933;cursor:pointer'>"+m+" "+"<a href="+this.tiles[v].facetItem.Href.replace(/'/g,"%27")+" target=\"_blank\"><img style='cursor:default;' id='pv-linkout' title='Follow the link' src='Content/images/goout.gif'></img></a></td><td id='pv-facet' class='tooltipcustom' title='Clear relation selection' style='color:#009933;cursor:pointer'>"+y+"</td><td id='pv-value' class='tooltipinter 'title='Filter on this value' style='color:#009933;cursor:pointer'>"+b+" "+"<a href="+b+" target=\"_blank\"><img style='cursor:default;' id=pv-linkout' title='Follow the link' src='Content/images/goout.gif'></img></a></td></tr>"}):u.push({key:g,value:"<tr class='pv-tableview-"+h+"'><td id='pv-key' class='tooltipinter' title='Toggle item selection' style='color:#009933;cursor:pointer'>"+m+" "+"<a href="+this.tiles[v].facetItem.Href.replace(/'/g,"%27")+" target=\"_blank\"><img style='cursor:default;' id='pv-linkout' title='Follow the link' src='Content/images/goout.gif'></img></a></td><td id='pv-facet' class='tooltipcustom' title='Clear relation selection' style='color:#009933;cursor:pointer'>"+y+"</td><td id='pv-value' class='tooltipinter' title='Filter on this value' style='color:#009933;cursor:pointer'>"+b+"</td></tr>"}):this.IsUri(b)?u.push({key:g,value:"<tr class='pv-tableview-"+h+"'><td id='pv-key' class='tooltipcustom' title='Toggle item selection'>"+m+"</td><td id='pv-facet' class-'tooltipcustom' title='Clear relation selection' style='color:#009933;cursor:pointer'>"+y+"</td><td id='pv-value' class='tooltipinter' title='Filter on this value' style='color:#009933;cursor:pointer'>"+b+" "+"<a href="+b+" target=\"_blank\"><img style='cursor:default;' id=pv-linkout' title='Follow the link' src='Content/images/goout.gif'></img></a></td></tr>"}):u.push({key:g,value:"<tr class='pv-tableview-"+h+"'><td id='pv-key' class='tooltipcustom' title='Toggle item selection'>"+m+"</td><td id='pv-facet' class-'tooltipcustom' title='Clear relation selection' style='color:#009933;cursor:pointer'>"+y+"</td><td id='pv-value' class='tooltipinter' title='Filter on this value' style='color:#009933;cursor:pointer'>"+b+"</td></tr>"}):this.tiles[v].facetItem.Href?this.IsUri(b)?u.push({key:g,value:"<tr class='pv-tableview-"+h+"'><td id='pv-key' class='tooltipinter' title='Click the cell to select this item' style='color:#009933;cursor:pointer'>"+m+" "+"<a href="+this.tiles[v].facetItem.Href.replace(/'/g,"%27")+" target=\"_blank\"><img style='cursor:default;' id='pv-linkout' title='Follow the link' src='Content/images/goout.gif'></img></a></td><td id='pv-facet' class='tooltipcustom' title='Clear relation selection' style='color:#009933;cursor:pointer'>"+y+"</td><td id='pv-value'><a href="+b+">"+b+"</a></td></tr>"}):u.push({key:g,value:"<tr class='pv-tableview-"+h+"'><td id='pv-key' class='tooltipinter' title='Click the cell to select this item' style='color:#009933;cursor:pointer'>"+m+" "+"<a href="+this.tiles[v].facetItem.Href.replace(/'/g,"%27")+" target=\"_blank\"><img style='cursor:default;' id='pv-linkout' title='Follow the link' src='Content/images/goout.gif'></img></a></td><td id='pv-facet' class='tooltipcustom' title='Clear relation selection' style='color:#009933;cursor:pointer'>"+y+"</td><td id='pv-value'>"+b+"</td></tr>"}):this.IsUri(b)?u.push({key:g,value:"<tr class='pv-tableview-"+h+"'><td id='pv-key' class='tooltipcustom' title='Toggle item selection'>"+m+"</td><td id='pv-facet' class-'tooltipcustom' title='Clear relation selection' style='color:#009933;cursor:pointer'>"+y+"</td><td id='pv-value'><a href"+b+">"+b+"</a></td></tr>"}):u.push({key:g,value:"<tr class='pv-tableview-"+h+"'><td id='pv-key' class='tooltipcustom' title='Toggle item selection'>"+m+"</td><td id='pv-facet' class-'tooltipcustom' title='Clear relation selection' style='color:#009933;cursor:pointer'>"+y+"</td><td id='pv-value'>"+b+"</td></tr>"}),h=="odd-row"?h="even-row":h="odd-row"}break}}}if(u.length==0)this.CreateTable(e,"",n,r);else{u.sort(function(e,t){return e.key>t.key?1:e.key<t.key?-1:0}),r&&u.reverse();for(var d=0;d<u.length;d++)p+=u[d].value;p+="</table>",s.append(p),$("#pv-table-data").colResizable({disable:!0}),$("#pv-table-data").colResizable({disable:!1}),$(".pv-tableview-heading").on("click",function(e){$("#pv-table-loader").show();var t=e.originalEvent.target.id,n=[];$(".tooltipinter").tooltipster("hide"),$(".tooltipcustom").tooltipster("hide"),i.selectedId==""||i.selectedId==null?n=i.currentFilter:n[0]=i.selectedId;var r;t=="pv-key"?(i.sortReverseEntity?r=!1:r=!0,i.sortReverseEntity=r):t=="pv-facet"?(i.sortReverseAttribute?r=!1:r=!0,i.sortReverseAttribute=r):t=="pv-value"&&(i.sortReverseValue?r=!1:r=!0,i.sortReverseValue=r),i.sortKey=t,i.CreateTable(n,i.selectedFacet,t,r),$("#pv-table-loader").fadeOut()}),$(".pv-tableview-odd-row").on("click",function(e){$("#pv-table-loader").show(),$(".tooltipinter").tooltipster("hide"),$(".tooltipcustom").tooltipster("hide");var t=e.originalEvent.target.id;i.CellClick(t,e.currentTarget.cells),$("#pv-table-loader").fadeOut()}),$(".pv-tableview-even-row").on("click",function(e){$("#pv-table-loader").show(),$(".tooltipinter").tooltipster("hide"),$(".tooltipcustom").tooltipster("hide");var t=e.originalEvent.target.id;i.CellClick(t,e.currentTarget.cells),$("#pv-table-loader").fadeOut()})}},Selected:function(e){var t=[];e==""||e==null||typeof e==undefined?(this.selectedId="",this.CreateTable(this.currentFilter,this.selectedFacet)):(t[0]=e,this.selectedId=e,this.CreateTable(t,this.selectedFacet))},SetFacetCategories:function(e){this.categories=e.FacetCategories},IsFilterVisible:function(e){var t=null;for(i=0;i<this.categories.length;i++)this.categories[i].Name==e&&(t=this.categories[i].IsFilterVisible);return t!=null?t:!1},IsUri:function(e){var t=e,n=!1;return typeof e=="string"&&(t.substring(0,5)=="http:"&&(n=!0),t.substring(0,6)=="https:"&&(n=!0)),n},SetSelectedFacet:function(e){this.selectedFacet=e},GetSelectedFacet:function(){return this.selectedFacet}}),PivotViewer.Views.MapView=PivotViewer.Views.IPivotViewerView.subClass({init:function(){this._super(),this.locCache=Array(),this.locList=Array(),this.inScopeLocList=Array(),this.map,this.markers=Array(),this.selectedItemId,this.geocodeList=Array(),this.itemsToGeocode=Array(),this.startGeocode,this.geocodeZero,this.mapInitZoom="",this.mapInitType="",this.mapInitCentreX="",this.mapInitCentreY="",this.mapZoom="",this.mapType="",this.mapCentreX="",this.mapCentreY="",this.applyBookmark=!1;var e=this},Setup:function(e,t,n,r,i){this.width=e,this.height=t,this.offsetX=n,this.offsetY=r,this.currentWidth=this.width,this.currentHeight=this.height,this.currentOffsetX=this.offsetX,this.currentOffsetY=this.offsetY,Modernizr.localstorage?this.localStorage=!0:this.localStorage=!1},Filter:function(e,t,n,r,i,s){var o=this,u=0;if(!Modernizr.canvas)return;Debug.Log("Map View Filtered: "+t.length),i&&($(".pv-viewarea-canvas").fadeOut(),$(".pv-tableview-table").fadeOut(),$(".pv-toolbarpanel-zoomslider").fadeOut(),$(".pv-toolbarpanel-zoomcontrols").css("border-width","0"),$(".pv-mapview-canvas").fadeIn(function(){s&&$.publish("/PivotViewer/Views/Item/Selected",[{id:s.Id,bkt:0}])})),this.tiles=e,this.currentFilter=t,this.selectedItemId="",this.inScopeLocList=[];for(var a=0;a<t.length;a++)for(var f=0;f<this.tiles.length;f++)if(this.tiles[f].facetItem.Id==t[a]){var l,c,h=!1,p=!1,d=!1,v=!1,m=this.tiles[f].facetItem.Id,g=this.tiles[f].facetItem.Name;for(var y=0;y<this.locList.length;y++)if(this.locList[y].id==m){(this.locList[y].loc.lat()!=0||this.locList[y].loc.lng()!=0)&&this.inScopeLocList.push(this.locList[y]),v=!0;break}if(!v){for(k=0;k<this.tiles[f].facetItem.Facets.length;k++)if(this.tiles[f].facetItem.Facets[k].Name.toUpperCase().indexOf("LATITUDE")>=0){var b=this.GetFacetCategoryType(this.tiles[f].facetItem.Facets[k].Name);if(b=="String")l=parseFloat(this.tiles[f].facetItem.Facets[k].FacetValues[0].Value);else{if(b!="Number")break;l=this.tiles[f].facetItem.Facets[k].FacetValues[0].Value}h=!0;if(p){var w=new google.maps.LatLng(l,c);this.locList.push({id:m,loc:w,title:g}),this.inScopeLocList.push({id:m,loc:w,title:g}),d=!0;break}}else if(this.tiles[f].facetItem.Facets[k].Name.toUpperCase().indexOf("LONGITUDE")>=0){var b=this.GetFacetCategoryType(this.tiles[f].facetItem.Facets[k].Name);if(b=="String")c=parseFloat(this.tiles[f].facetItem.Facets[k].FacetValues[0].Value);else{if(b!="Number")break;c=this.tiles[f].facetItem.Facets[k].FacetValues[0].Value}p=!0;if(h){var w=new google.maps.LatLng(l,c);this.locList.push({id:m,loc:w,title:g}),this.inScopeLocList.push({id:m,loc:w,title:g}),d=!0;break}}if(!d)for(var E=0;E<this.tiles[f].facetItem.Facets.length;E++)if(this.tiles[f].facetItem.Facets[E].Name.toUpperCase().indexOf("LOCATION")>=0){for(var S=0;S<this.tiles[f].facetItem.Facets[E].FacetValues.length;S++){var x=this.tiles[f].facetItem.Facets[E].FacetValues[S].Value,T=!1;if(x.toUpperCase().indexOf("POINT(")==0){c=x.substring(6,x.indexOf(" ",6)-6),l=x.substring(x.indexOf(" ",6)+1,x.indexOf(")")-(x.indexOf(" ")+1));if(l!="NaN"&&c!="NaN"){var N=parseFloat(l),C=parseFloat(logitude);if(!isNaN(N)&&!isNaN(C)){var w=new google.maps.LatLng(N,C);locList.push({id:m,loc:w,title:g}),inScopeList.push({id:m,loc:w,title:g}),d=!0;break}}else T=!0}else if(x.indexOf(",")>-1){var N=parseFloat(x.substring(0,x.indexOf(","))),C=parseFloat(x.substring(x.indexOf(",")));if(!isNaN(N)&&!isNaN(C)){var w=new google.maps.LatLng(N,C);locList.push({id:m,loc:w,title:g}),inScopeList.push({id:m,loc:w,title:g}),d=!0;break}T=!0}if(!T&&x.length>1){var L=x.replace("_"," ").toUpperCase();for(var A=0;A<this.tiles[f].facetItem.Facets.length;A++)if(this.tiles[f].facetItem.Facets[A].Name.toUpperCase().indexOf("REGION")>=0){var O=this.tiles[f].facetItem.Facets[A].FacetValues[0].Value;O.length>1&&(L=L+", "+O.replace("_"," ").toUpperCase());break}for(var M=0;M<this.tiles[f].facetItem.Facets.length;M++)if(this.tiles[f].facetItem.Facets[M].Name.toUpperCase().indexOf("COUNTRY")>=0){var _=this.tiles[f].facetItem.Facets[M].FacetValues[0].Value;_.length>1&&(L=L+", "+_.replace("_"," ").toUpperCase());break}for(var D=0;D<this.locCache.length;D++)if(this.locCache[D].locName==L){this.locList.push({id:m,loc:this.locCache[D].loc,title:g}),this.inScopeLocList.push({id:m,loc:this.locCache[D].loc,title:g}),d=!0;break}if(!d){if(this.localStorage){var P,w=JSON.parse(localStorage.getItem(L)),N=parseFloat(w.lat),H=parseFloat(w.lng);!NaN(N)&&!NaN(H)&&(P=new google.maps.LatLng(N,H),this.locCache.push({locName:L,loc:P}),this.locList.push({id:m,loc:P,title:g}),this.inScopeLocList.push({id:m,loc:P,title:g}),d=!0)}if(!d&&u<1e3){var B=!1;for(var u=0;u<this.geocodeList.length;u++)if(this.geocodeList[u]==L){B=!0;break}B||(this.geocodeList.push(L),u++),this.itemsToGeocode.push({id:m,locName:L,title:g}),d=!0;break}}}}if(d)break}}}if(this.inScopeLocList.length==0&&u==0){this.ShowMapError();return}u>0&&this.GetLocationsFromNames(),$(".pv-mapview-canvas").css("height",this.height-12+"px"),$(".pv-mapview-canvas").css("width",this.width-415+"px"),s?this.CreateMap(s.Id):this.CreateMap("")},GetUI:function(){return""},GetButtonImage:function(){return"Content/images/MapView.png"},GetButtonImageSelected:function(){return"Content/images/MapViewSelected.png"},GetViewName:function(){return"Map View"},MakeGeocodeCallBack:function(e){var t=this,n=function(n,r){var i=new google.maps.LatLng(0,0),s=i;if(r==google.maps.GeocoderStatus.OK)var s=n[0].geometry.location;else var s=i;t.locCache.push({locName:e,loc:s});if(this.localStorage){var o={lat:s.lat(),lng:s.lng()};localStorage.setItem(e,JSON.stringify(o))}for(var u=0;u<t.itemsToGeocode.length;u++){var a=t.itemsToGeocode[u].id,f=t.itemsToGeocode[u].locName,l=t.itemsToGeocode[u].title;f==e&&(t.locList.push({id:a,loc:s,title:l}),(s.lat()!=0||s.lng()!=0)&&t.inScopeLocList.push({id:a,loc:s,title:l}))}var c=!0;for(var h=0;h<t.geocodeList.length;h++){var f=t.geocodeList[h],p=!0;for(var d=0;d<t.locCache.length;d++)if(t.locCache[d].locName==f){p=!1;break}if(p){c=!1;break}}var v=new Date;(v.getTime()-t.geocodeZero.getTime())/1e3>20?(t.RedrawMarkers(t.selectedItemId),t.startGeocode=new Date):(v.getTime()-t.startGeocode.getTime())/1e3>2&&(t.RedrawMarkers(t.selectedItemId),t.RefitBounds(),t.startGeocode=new Date);if(c||t.geocodeList.Count==0){t.geocodeList=[];if(t.inScopeLocList.Count==0){this.ShowMapError();return}t.CreateMap(t.selectedItemId),t.applyBookmark&&(t.SetBookmark(),t.applyBookmark=!1)}};return n},GetLocationsFromNames:function(){var e=new google.maps.Geocoder,t=this;for(l=0;l<this.itemsToGeocode.length;l++){var n=this.itemsToGeocode[l].locName;e.geocode({address:n},this.MakeGeocodeCallBack(n))}this.startGeocode=new Date,this.startGeocode.setSeconds(this.startGeocode.getSeconds()+2),this.geocodeZero=new Date},CreateMap:function(e){var t=this,n,r=8,i=google.maps.MapTypeId.ROADMAP,s=!1;centreLat=parseFloat(this.mapCentreX),centreLng=parseFloat(this.mapCentreY),!isNaN(centreLat)&&!isNaN(centreLng)&&(n=new google.maps.LatLng(centreLat,centreLng),s=!0),bookmarkZoom=parseInt(this.mapZoom),isNaN(bookmarkZoom)||(r=bookmarkZoom),this.mapType&&this.mapType!=""&&(i=this.mapType),this.map=new google.maps.Map(document.getElementById("pv-map-canvas")),s?this.map.panTo(n):this.selectedItemId&&this.CentreOnSelected(this.selectedItemId),this.map.setMapTypeId(i),this.map.setZoom(r),google.maps.event.addListener(this.map,"maptypeid_changed",function(){t.SetMapType(t.map.getMapTypeId()),$.publish("/PivotViewer/Views/Item/Updated",null)}),google.maps.event.addListener(this.map,"zoom_changed",function(){t.SetMapZoom(t.map.getZoom()),$.publish("/PivotViewer/Views/Item/Updated",null)}),google.maps.event.addListener(this.map,"center_changed",function(){var e=t.map.getCenter();t.SetMapCentreX(e.lat()),t.SetMapCentreY(e.lng()),$.publish("/PivotViewer/Views/Item/Updated",null)}),this.CreateMarkers(),this.RefitBounds()},SetFacetCategories:function(e){this.categories=e.FacetCategories},GetFacetCategoryType:function(e){for(i=0;i<this.categories.length;i++)if(this.categories[i].Name==e)return this.categories[i].Type;return"not set"},CreateMarkers:function(){var e=this;for(var t=0;t<this.markers.length;t++)this.markers[t].setMap(null);this.markers=[];for(t=0;t<this.inScopeLocList.length;t++)marker=new google.maps.Marker({position:this.inScopeLocList[t].loc,map:this.map,icon:"http://maps.google.com/mapfiles/ms/icons/red-dot.png",title:this.inScopeLocList[t].title}),this.inScopeLocList[t].id==this.selectedItemId&&(marker.setIcon("http://maps.google.com/mapfiles/ms/icons/green-dot.png"),marker.setZIndex(1e9)),google.maps.event.addListener(marker,"click",function(t,n){return function(){if(e.selectedItemId==e.inScopeLocList[n].id)t.setIcon("http://maps.google.com/mapfiles/ms/icons/red-dot.png"),e.selectedItemId="",$.publish("/PivotViewer/Views/Update/GridSelection",[{selectedItem:e.selectedItemId,selectedTile:selectedTile}]);else{e.selectedItemId=e.inScopeLocList[n].id;for(var r=0;r<e.tiles.length;r++)if(e.tiles[r].facetItem.Id==e.selectedItemId){selectedTile=e.tiles[r],$.publish("/PivotViewer/Views/Update/GridSelection",[{selectedItem:e.selectedItemId,selectedTile:selectedTile}]);break}}}}(marker,t)),this.markers.push(marker)},RefitBounds:function(){var e=new google.maps.LatLngBounds;for(i=0;i<this.markers.length;i++)e.extend(this.markers[i].position);this.map.fitBounds(e),this.currentFilter.length==1&&this.map.getZoom()>15&&this.map.setZoom(15)},RedrawMarkers:function(e){this.selectedItemId=e;for(var t=0;t<this.markers.length;t++)this.markers[t].setMap(null);this.markers=[],this.CreateMarkers(),this.CentreOnSelected(e)},ShowMapError:function(){var e="";e+="The current data selection does not contain any location information that can be shown on a map<br><br>",e+="<br>Choose a different view<br>",$(".pv-wrapper").append('<div id="pv-dzlocation-error" class="pv-modal-dialog"><div><a href="#pv-modal-dialog-close" title="Close" class="pv-modal-dialog-close">X</a><h2>HTML5 PivotViewer</h2><p>'+e+"</p></div></div>");var t=setTimeout(function(){window.open("#pv-dzlocation-error","_self")},1e3);return},GetMapCentreX:function(){return this.mapCentreX},SetMapCentreX:function(e){this.mapCentreX=e},SetMapInitCentreX:function(e){this.mapCentreX=e,this.mapInitCentreX=e},GetMapCentreY:function(){return this.mapCentreY},SetMapCentreY:function(e){this.mapCentreY=e},SetMapInitCentreY:function(e){this.mapCentreY=e,this.mapInitCentreY=e},GetMapType:function(){return this.mapType},SetMapType:function(e){this.mapType=e},SetMapInitType:function(e){this.mapType=e,this.mapInitType=e},GetMapZoom:function(){return this.mapZoom},SetMapZoom:function(e){this.mapZoom=e},SetMapInitZoom:function(e){this.mapZoom=e,this.mapInitZoom=e},CentreOnSelected:function(e){for(j=0;j<this.locList.length;j++)this.locList[j].id==e&&this.locList[j].loc.lat()!=0&&this.locList[j].loc.lng()!=0&&this.map.panTo(this.locList[j].loc)},SetBookmark:function(){var e,t=8,n=google.maps.MapTypeId.ROADMAP,r=!1;centreLat=parseFloat(this.mapInitCentreX),centreLng=parseFloat(this.mapInitCentreY),!isNaN(centreLat)&&!isNaN(centreLng)&&centreLat!=0&&centreLng!=0&&(e=new google.maps.LatLng(centreLat,centreLng),r=!0),bookmarkZoom=parseInt(this.mapInitZoom),isNaN(bookmarkZoom)||(t=bookmarkZoom),this.mapInitType&&this.mapInitType!=""&&(n=this.mapInitType),r&&this.map.panTo(e),this.map.setMapTypeId(n),this.map.setZoom(t)}}),PivotViewer.Views.IImageController=Object.subClass({init:function(){},Setup:function(e){},GetImagesAtLevel:function(e,t){},Width:0,Height:0}),PivotViewer.Views.LoadImageSetHelper=Object.subClass({init:function(){this._images=[],this._loaded=!1},LoadImages:function(e){var t=this;for(var n=0;n<e.length;n++){var r=new Image;r.src=e[n],r.onload=function(){t._loaded=!0},this._images.push(r)}},GetImages:function(){return this._images},IsLoaded:function(){return this._loaded}}),PivotViewer.Views.DeepZoomImageController=PivotViewer.Views.IImageController.subClass({init:function(){this._items=[],this._collageItems=[],this._baseUrl="",this._collageMaxLevel=0,this._tileSize=256,this._format="",this._ratio=1,this.MaxRatio=1,this._zooming=!1;var e=this;$.subscribe("/PivotViewer/ImageController/Zoom",function(t){e._zooming=t})},Setup:function(e){this._baseUrl=e.substring(0,e.lastIndexOf("/")),this._collageUrl=e.substring(e.lastIndexOf("/")+1).replace(".xml","_files");var t=this;$.ajax({type:"GET",url:e,dataType:"xml",success:function(e){var n=$(e).find("Collection");t._tileSize=$(n).attr("TileSize"),t._format=$(n).attr("Format"),t._collageMaxLevel=$(n).attr("MaxLevel");var r=$(e).find("I");if(r.length==0){$(".pv-loading").remove();var s="";s+="No items in the DeepZoom Collection<br><br>",s=s+"URL        : "+this.url+"<br>",s+="<br>Pivot Viewer cannot continue until this problem is resolved<br>",$(".pv-wrapper").append('<div id="pv-dzloading-error" class="pv-modal-dialog"><div><a href="#pv-modal-dialog-close" title="Close" class="pv-modal-dialog-close">X</a><h2>HTML5 PivotViewer</h2><p>'+s+"</p></div></div>");var o=setTimeout(function(){window.open("#pv-dzloading-error","_self")},1e3);return}var u=$(r[0]).find("Size");if(u.length>0){t.MaxWidth=parseInt(u.attr("Width")),t.Height=parseInt(u.attr("Height")),t.MaxRatio=t.Height/t.MaxWidth;for(i=0;i<r.length;i++){itemSize=$(r[i]).find("Size");var a=parseInt(itemSize.attr("Width")),f=parseInt(itemSize.attr("Height")),l=a>f?a:f,c=Math.ceil(Math.log(l)/Math.log(2));t._ratio=f/a;var h=$(r[i]).attr("Source"),p=$(r[i]).attr("Id"),d=$(r[i]).attr("N"),v=h.substring(h.lastIndexOf("/")+1).replace(/\.xml/gi,"").replace(/\.dzi/gi,""),m=h.substring(0,h.lastIndexOf("/"));m.length>0&&(m+="/"),a>t.MaxWidth&&(t.MaxWidth=a),t._ratio<t.MaxRatio&&(t.MaxRatio=t._ratio),t._items.push(new PivotViewer.Views.DeepZoomItem(p,v,d,m,t._ratio,a,f,c,t._baseUrl,h))}}$.publish("/PivotViewer/ImageController/Collection/Loaded",null)},error:function(e,t,n){$(".pv-loading").remove();var r="";r+="Error loading from DeepZoom Cache<br><br>",r=r+"URL        : "+this.url+"<br>",r=r+"Status : "+e.status+" "+n+"<br>",r=r+"Details    : "+e.responseText+"<br>",r+="<br>Pivot Viewer cannot continue until this problem is resolved<br>",$(".pv-wrapper").append('<div id="pv-dzloading-error" class="pv-modal-dialog"><div><a href="#pv-modal-dialog-close" title="Close" class="pv-modal-dialog-close">X</a><h2>HTML5 PivotViewer</h2><p>'+
r+"</p></div></div>");var i=setTimeout(function(){window.open("#pv-dzloading-error","_self")},1e3)}})},GetImagesAtLevel:function(e,t){t=t<=0?6:t;for(var n=0;n<this._items.length;n++)if(this._items[n].ItemId==e){t=t>this._items[n].MaxLevel?this._items[n].MaxLevel:t;var r=this._items[n].DZN.toString(2),i="",s="";for(var o=0;o<r.length;o++)o%2==0?i+=r[o]:s+=r[o];dzCol=parseInt(i,2),dzRow=parseInt(s,2);if(this._items[n].Levels!=undefined&&this._items[n].Levels.length!=0||!!this._zooming){if(this._items[n].Levels.length<t&&!this._zooming){var u=this.GetImageList(n,this._baseUrl+"/"+this._items[n].BasePath+this._items[n].DZId+"_files/"+t+"/",t),a=new PivotViewer.Views.LoadImageSetHelper;a.LoadImages(u),this._items[n].Levels.splice(t,0,a)}for(var f=t;f>-1;f--){if(this._items[n].Levels[f]!=undefined&&this._items[n].Levels[f].IsLoaded())return this._items[n].Levels[f].GetImages();if(f==t&&this._items[n].Levels[f]==undefined&&!this._zooming){var u=this.GetImageList(n,this._baseUrl+"/"+this._items[n].BasePath+this._items[n].DZId+"_files/"+f+"/",f),a=new PivotViewer.Views.LoadImageSetHelper;a.LoadImages(u),this._items[n].Levels.splice(f,0,a)}}return null}var u=this.GetImageList(n,this._baseUrl+"/"+this._items[n].BasePath+this._items[n].DZId+"_files/6/",6),a=new PivotViewer.Views.LoadImageSetHelper;return a.LoadImages(u),this._items[n].Levels.push(a),null}return null},GetImageList:function(e,t,n){var r=[],i=this._tileSize,s=this._format,o=this._items[e].Ratio,u=this._items[e].Height,a=this._items[e].MaxLevel,f=Math.ceil(u/o/Math.pow(2,a-n)),l=Math.ceil(u/Math.pow(2,a-n)),c=Math.ceil(f/i),h=Math.ceil(l/i);for(var p=0;p<c;p++)for(var d=0;d<h;d++)r.push(t+p+"_"+d+"."+s);return r},GetWidthForImage:function(e,t){for(var n=0;n<this._items.length;n++)if(this._items[n].ItemId==e)return Math.floor(t/this._items[n].Ratio)},GetDzi:function(e){for(var t=0;t<this._items.length;t++)if(this._items[t].ItemId==e)return dziName=this._baseUrl+"/"+this._items[t].BasePath+this._items[t].DZId+".dzi",dziName},GetMaxLevel:function(e){for(var t=0;t<this._items.length;t++)if(this._items[t].ItemId==e)return this._items[t].MaxLevel},GetWidth:function(e){for(var t=0;t<this._items.length;t++)if(this._items[t].ItemId==e)return this._items[t].Width},GetHeight:function(e){for(var t=0;t<this._items.length;t++)if(this._items[t].ItemId==e)return this._items[t].Height},GetOverlap:function(e){for(var t=0;t<this._items.length;t++)if(this._items[t].ItemId==e)return this._items[t].Overlap},GetRatio:function(e){for(var t=0;t<this._items.length;t++)if(this._items[t].ItemId==e)return this._items[t].Ratio}}),PivotViewer.Views.DeepZoomItem=Object.subClass({init:function(e,t,n,r,i,s,o,u,a,f){this.ItemId=e,this.DZId=t,this.DZN=parseInt(n),this.BasePath=r,this.Levels=[],this.Ratio=i,this.Width=s,this.Height=o,this.MaxLevel=u;var l=this;$.ajax({type:"GET",url:a+"/"+f,dataType:"xml",success:function(e){var t=$(e).find("Image");if(t.length==0)return;var n=$(t[0]);l.Overlap=n.attr("Overlap")},complete:function(e,t){},error:function(e,t,n){l.Overlap=0}})}}),PivotViewer.Views.TileController=Object.subClass({init:function(e){this._tiles=[],this._helpers=[],this._helperText="",this._easing=new Easing.Easer({type:"circular",side:"both"}),this._imageController=e},initTiles:function(e,t,n){for(var r=0;r<e.length;r++){var i=new PivotViewer.Views.Tile(this._imageController);i.facetItem=e[r],i.CollectionRoot=t.replace(/\\/gi,"/").replace(/\.xml/gi,""),this._canvasContext=n,i.context=this._canvasContext,tileLocation=new PivotViewer.Views.TileLocation,i._locations.push(tileLocation),this._tiles.push(i)}return this._tiles},AnimateTiles:function(e,n){var r=this;this._started=!0;var i=null,s=!1;if(this._tiles.length>0&&this._tiles[0].context!=null){i=this._tiles[0].context;var o=!1;for(var u=0;u<this._tiles.length;u++)for(c=0;c<this._tiles[u]._locations.length;c++){var a=PivotViewer.Utils.Now()-this._tiles[u].start,f=this._tiles[u].end-this._tiles[u].start;if(a<=f){if(this._tiles[u]._locations[c].x!=this._tiles[u]._locations[c].destinationx||this._tiles[u]._locations[c].y!=this._tiles[u]._locations[c].destinationy)o=!0;this._tiles[u]._locations[c].x=this._easing.ease(a,this._tiles[u]._locations[c].startx,this._tiles[u]._locations[c].destinationx-this._tiles[u]._locations[c].startx,f),this._tiles[u]._locations[c].y=this._easing.ease(a,this._tiles[u]._locations[c].starty,this._tiles[u]._locations[c].destinationy-this._tiles[u]._locations[c].starty,f);if(this._tiles[u].width!=this._tiles[u].destinationWidth||this._tiles[u].height!=this._tiles[u].destinationHeight)o=!0;this._tiles[u].width=this._easing.ease(a,this._tiles[u].startwidth,this._tiles[u].destinationwidth-this._tiles[u].startwidth,f),this._tiles[u].height=this._easing.ease(a,this._tiles[u].startheight,this._tiles[u].destinationheight-this._tiles[u].startheight,f)}else{this._tiles[u]._locations[c].x=this._tiles[u]._locations[c].destinationx,this._tiles[u]._locations[c].y=this._tiles[u]._locations[c].destinationy,this._tiles[u].width=this._tiles[u].destinationwidth,this._tiles[u].height=this._tiles[u].destinationheight;if(!isNaN(a)&&!isNaN(f)&&e){var l="";for(t=0;t<this._tiles.length;t++)if(this._tiles[t].facetItem.Id==n){l=this._tiles[t];break}n&&l&&$.publish("/PivotViewer/Views/Canvas/Click",[{x:l._locations[l.selectedLoc].destinationx,y:l._locations[l.selectedLoc].destinationy}]),e=!1,n=0}}this._tiles[u]._locations[c].destinationx+this._tiles[u].destinationwidth<0||this._tiles[u]._locations[c].destinationx>i.canvas.width||this._tiles[u]._locations[c].destinationy+this._tiles[u].destinationheight<0||this._tiles[u]._locations[c].destinationy>i.canvas.height?this._tiles[u].destinationVisible=!1:this._tiles[u].destinationVisible=!0}}this._isZooming!=o&&(this._isZooming=o,$.publish("/PivotViewer/ImageController/Zoom",[this._isZooming])),i.clearRect(0,0,i.canvas.width,i.canvas.height);for(var u=0;u<this._tiles.length;u++)for(var c=0;c<this._tiles[u]._locations.length;c++)this._tiles[u]._locations[c].x+this._tiles[u].width>0&&this._tiles[u]._locations[c].x<i.canvas.width&&this._tiles[u]._locations[c].y+this._tiles[u].height>0&&this._tiles[u]._locations[c].y<i.canvas.height&&(s?this._tiles[u].DrawEmpty(c):this._tiles[u].Draw(c));if(!!this._breaks){this._started=!1;return}requestAnimFrame(function(){r.AnimateTiles(e,n)})},BeginAnimation:function(e,t){!this._started&&this._tiles.length>0&&(this._breaks=!1,this.AnimateTiles(e,t))},StopAnimation:function(){this._breaks=!0},SetLinearEasingBoth:function(){this._easing=new Easing.Easer({type:"linear",side:"both"})},SetCircularEasingBoth:function(){this._easing=new Easing.Easer({type:"circular",side:"both"})},SetQuarticEasingOut:function(){this._easing=new Easing.Easer({type:"quartic",side:"out"})},GetMaxTileRatio:function(){return this._imageController.MaxRatio},DrawHelpers:function(e){this._helpers=e},DrawHelperText:function(e){this._helperText=e}}),PivotViewer.Views.Tile=Object.subClass({init:function(e){if(!(this instanceof PivotViewer.Views.Tile))return new PivotViewer.Views.Tile(e);this._controller=e,this._imageLoaded=!1,this._selected=!1,this._level=0,this._images=null,this._locations=[]},IsSelected:function(){return this._selected},Draw:function(e){if(this.destinationVisible){var t=this.width>this.height?this.width:this.height,n=Math.ceil(Math.log(t)/Math.log(2));if(n==Infinity||n==-Infinity)n=0;this._level=n,this._images=this._controller.GetImagesAtLevel(this.facetItem.Img,this._level)}if(this._images!=null){if(typeof this._images=="function")this._images(this.facetItem,this.context,this._locations[e].x+4,this._locations[e].y+4,this.width-8,this.height-8);else if(this._images.length>0&&this._images[0]instanceof Image){var r=this._controller.GetHeight(this.facetItem.Img),i=this.height-8,s=Math.ceil(this._controller.GetWidthForImage(this.facetItem.Img,i));blankWidth=this.width-8-s;for(var o=0;o<this._images.length;o++){var u=this._images[o].src,a=this._controller._tileSize,f=u.match(/[0-9]+_[0-9]+/g),l=parseInt(f[f.length-1].substring(0,f[f.length-1].indexOf("_"))),c=parseInt(f[f.length-1].substring(f[f.length-1].indexOf("_")+1));f=u.match(/_files\/[0-9]+\//g);var h=parseInt(f[0].substring(7,f[0].length-1)),p=Math.ceil(r/Math.pow(2,this._controller.GetMaxLevel(this.facetItem.Img)-h)),d=i/p;overlap=this._controller.GetOverlap(this.facetItem.Img);var v=Math.floor(blankWidth/2)+4+l*Math.floor((a-overlap)*d),m=4+Math.floor(c*(a-overlap)*d),g=Math.ceil(this._images[o].height*d),y=Math.ceil(this._images[o].width*d);this.context.drawImage(this._images[o],v+this._locations[e].x,m+this._locations[e].y,y,g)}if(this._selected){this.context.beginPath();var v=Math.floor(blankWidth/2)+4,m=4;this.context.rect(v+this._locations[this.selectedLoc].x,m+this._locations[this.selectedLoc].y,s,i),this.context.lineWidth=4,this.context.strokeStyle="#92C4E1",this.context.stroke()}}}else this.DrawEmpty(e)},Contains:function(e,t){var n=!1,r=-1;for(i=0;i<this._locations.length;i++)n=this._locations[i].x<=e&&this._locations[i].x+this.width>=e&&this._locations[i].y<=t&&this._locations[i].y+this.height>=t,n&&(r=i);return r},DrawEmpty:function(e){this._controller.DrawLevel==undefined?(this.context.beginPath(),this.context.fillStyle="#D7DDDD",this.context.fillRect(this._locations[e].x+4,this._locations[e].y+4,this.width-8,this.height-8),this.context.rect(this._locations[e].x+4,this._locations[e].y+4,this.width-8,this.height-8),this.context.lineWidth=1,this.context.strokeStyle="white",this.context.stroke()):this._controller.DrawLevel(this.facetItem,this.context,this._locations[e].x+4,this._locations[e].y+4,this.width-8,this.height-8)},CollectionRoot:"",now:null,end:null,width:0,height:0,origwidth:0,origheight:0,ratio:1,startwidth:0,startheight:0,destinationwidth:0,destinationheight:0,destinationVisible:!0,context:null,facetItem:null,firstFilterItemDone:!1,selectedLoc:0,Selected:function(e){this._selected=e}}),PivotViewer.Views.TileLocation=Object.subClass({init:function(){},x:0,y:0,startx:0,starty:0,destinationx:0,destinationy:0}),function(e){var n=[],r=[],s=[],o=[],u=[],a=[],f=[],l=0,c,h,p=[],d=[],v="",m=0,g="",y="",b="",w="",E="",S="",x=!1,T="",N="",C,k=null,L=null,A={View:null,Facet:null,Filters:[]},O=null,M={},_=!1,D,P=new PivotViewer.Models.Collection,H={init:function(e){O=this,O.addClass("pv-wrapper"),InitPreloader();if(e.Loader==undefined)throw"Collection loader is undefined.";if(!(e.Loader instanceof PivotViewer.Models.Loaders.ICollectionLoader))throw"Collection loader does not inherit from PivotViewer.Models.Loaders.ICollectionLoader.";e.Loader.LoadCollection(P);if(e.ImageController==undefined)C=new PivotViewer.Views.DeepZoomImageController;else{if(!e.ImageController instanceof PivotViewer.Views.IImageController)throw"Image Controller does not inherit from PivotViewer.Views.IImageController.";C=e.ImageController}e.GoogleAPIKey!=undefined&&(D=e.GoogleAPIKey);if(e.ViewerState!=undefined){var t=e.ViewerState.split("&");for(var n=0,r=t.length;n<r;n++){var i=t[n].split("=");if(i.length==2)if(i[0]=="$view$")A.View=parseInt(i[1])-1;else if(i[0]=="$facet0$")A.Facet=PivotViewer.Utils.EscapeItemId(i[1]);else if(i[0]=="$selection$")A.Selection=PivotViewer.Utils.EscapeItemId(i[1]);else if(i[0]=="$tableFacet$")A.TableFacet=PivotViewer.Utils.EscapeItemId(i[1]);else if(i[0]=="$mapCentreX$")A.MapCentreX=i[1];else if(i[0]=="$mapCentreY$")A.MapCentreY=i[1];else if(i[0]=="$mapType$")A.MapType=PivotViewer.Utils.EscapeItemId(i[1]);else if(i[0]=="$mapZoom$")A.MapZoom=PivotViewer.Utils.EscapeItemId(i[1]);else{var s={Facet:i[0],Predicates:[]},o=i[1].split("_");for(var u=0,a=o.length;u<a;u++)if(o[u].indexOf(".")>0){var f=o[u].substring(0,o[u].indexOf(".")),l=o[u].substring(o[u].indexOf(".")+1);s.Predicates.push({Operator:f,Value:l})}A.Filters.push(s)}}}},show:function(){Debug.Log("Show")},hide:function(){Debug.Log("Hide")}};InitPreloader=function(){O.append("<div class='pv-loading'><img src='Content/images/loading.gif' alt='Loading' /><span>Loading...</span></div>"),e(".pv-loading").css("top",e(".pv-wrapper").height()/2-33+"px"),e(".pv-loading").css("left",e(".pv-wrapper").width()/2-43+"px")},InitTileCollection=function(){InitUI();var t=P.ImageBase;t.indexOf("http",0)>=0||t.indexOf("www.",0)>=0||(t=P.CXMLBase.substring(0,P.CXMLBase.lastIndexOf("/")+1)+t);var n=e(".pv-viewarea-canvas")[0].getContext("2d");h=new PivotViewer.Views.TileController(C),p=h.initTiles(P.Items,t,n),C.Setup(t.replace("\\","/"))},InitPivotViewer=function(){CreateFacetList(),CreateViews(),AttachEventHandlers(),e(".pv-loading").remove(),ApplyViewerState(),g=GetItem(A.Selection),y=A.TableFacet,b=A.MapCentreX,w=A.MapCentreY,E=A.MapType,S=A.MapZoom;var t=e(".pv-toolbarpanel").innerWidth()-(e(".pv-toolbarpanel-brandimage").outerWidth(!0)+25+e(".pv-toolbarpanel-name").outerWidth(!0)+e(".pv-toolbarpanel-zoomcontrols").outerWidth(!0)+124+e(".pv-toolbarpanel-sortcontrols").outerWidth(!0));e(".pv-toolbarpanel-facetbreadcrumb").css("width",t+"px");if(A.View!=null){if(A.View!=0||A.View!=1)SelectView(0,!0),x=!1;SelectView(A.View,!0)}else SelectView(0,!0);var r=g&&g.Id?g.Id:"";h.BeginAnimation(!0,r),l==3&&(g?(e.publish("/PivotViewer/Views/Item/Selected",[{id:g.Id,bkt:0}]),n[3].RedrawMarkers(g.Id)):(e.publish("/PivotViewer/Views/Item/Selected",[{id:"",bkt:0}]),n[3].RedrawMarkers("")))},InitUI=function(){var t="<div class='pv-toolbarpanel'>",n=P.BrandImage;n.length>0&&(t+="<img class='pv-toolbarpanel-brandimage' src='"+n+"'></img>"),t+="<span class='pv-toolbarpanel-name'>"+P.CollectionName+"</span>",t+="<div class='pv-toolbarpanel-facetbreadcrumb'></div>",t+="<div class='pv-toolbarpanel-zoomcontrols'><div class='pv-toolbarpanel-zoomslider'></div></div>",t+="<div class='pv-toolbarpanel-viewcontrols'></div>",t+="<div class='pv-toolbarpanel-sortcontrols'></div>",t+="</div>",O.append(t);var r=0;e(".pv-toolbarpanel-zoomslider").slider({max:100,change:function(t,n){var i=n.value-r;centreX=e(".pv-viewarea-canvas").width()/2,centreY=e(".pv-viewarea-canvas").height()/2,e.publish("/PivotViewer/Views/Canvas/Zoom",[{x:centreX,y:centreY,delta:.5*i}]),r=n.value}}),O.append("<div class='pv-mainpanel'></div>");var i=e(".pv-wrapper").height()-e(".pv-toolbarpanel").height()-6;e(".pv-mainpanel").css("height",i+"px"),e(".pv-mainpanel").append("<div class='pv-filterpanel'></div>"),e(".pv-mainpanel").append("<div class='pv-viewpanel'><canvas class='pv-viewarea-canvas' width='"+O.width()+"' height='"+i+"px'></canvas></div>"),e(".pv-mainpanel").append("<div class='pv-infopanel'></div>"),e(".pv-viewpanel").append("<div class='pv-tableview-table' id='pv-table'></div>"),e(".pv-viewpanel").append("<div class='pv-mapview-canvas' id='pv-map-canvas'></div>");var s=e(".pv-filterpanel");s.append("<div class='pv-filterpanel-clearall'>Clear All</div>").append("<input class='pv-filterpanel-search' type='text' placeholder='Search...' /><div class='pv-filterpanel-search-autocomplete'></div>").css("height",i-13+"px"),navigator.userAgent.match(/iPad/i)!=null?e(".pv-filterpanel-search").css("width",s.width()-10+"px"):e(".pv-filterpanel-search").css("width",s.width()-2+"px"),e(".pv-filterpanel-search-autocomplete").css("width",s.width()-8+"px").hide();var o=e(".pv-infopanel");o.css("left",e(".pv-mainpanel").offset().left+e(".pv-mainpanel").width()-205+"px").css("height",i-28+"px"),o.append("<div class='pv-infopanel-controls'></div>"),e(".pv-infopanel-controls").append("<div><div class='pv-infopanel-controls-navleft'></div><div class='pv-infopanel-controls-navleftdisabled'></div><div class='pv-infopanel-controls-navbar'></div><div class='pv-infopanel-controls-navright'></div><div class='pv-infopanel-controls-navrightdisabled'></div></div>"),e(".pv-infopanel-controls-navleftdisabled").hide(),e(".pv-infopanel-controls-navrightdisabled").hide(),o.append("<div class='pv-infopanel-heading'></div>"),o.append("<div class='pv-infopanel-details'></div>"),P.MaxRelatedLinks>0&&o.append("<div class='pv-infopanel-related'></div>"),P.CopyrightName!=""&&o.append("<div class='pv-infopanel-copyright'><a href=\""+P.CopyrightHref+'" target="_blank">'+P.CopyrightName+"</a></div>"),o.hide()},CreateFacetList=function(){for(var t=0;t<P.Items.length;t++){var n=P.Items[t];for(var i=0;i<P.FacetCategories.length;i++){var a=P.FacetCategories[i];if(a.IsFilterVisible){var f=!1;for(var l=0,c=n.Facets.length;l<c;l++){var h=n.Facets[l];if(h.Name==a.Name){for(var p=0;p<h.FacetValues.length;p++)if(a.Type==PivotViewer.Models.FacetType.String||a.Type==PivotViewer.Models.FacetType.Link){var d=!1,v="pv-facet-item-"+CleanName(h.Name)+"__"+CleanName(h.FacetValues[p].Value);for(var m=r.length-1;m>-1;m-=1)if(r[m].itemId==v){r[m].count+=1,d=!0;break}d||r.push({itemId:v,itemValue:h.FacetValues[p].Value,facet:h.Name,count:1})}else if(a.Type==PivotViewer.Models.FacetType.Number){var g=!1;for(var m=0;m<s.length;m++)if(s[m].Facet==n.Facets[l].Name){s[m].Values.push(h.FacetValues[p].Value),g=!0;break}g||s.push({Facet:h.Name,Values:[h.FacetValues[p].Value]})}else if(a.Type==PivotViewer.Models.FacetType.DateTime){var y=!1,v="pv-facet-item-"+CleanName(h.Name)+"__"+CleanName(h.FacetValues[p].Value);for(var m=0;m<o.length;m++)if(o[m].itemId==v){o[m].count+=1,y=!0;break}y||o.push({itemId:v,itemValue:h.FacetValues[p].Value,facet:h.Name,count:1})}f=!0}}if(!f){var d=!1,v="pv-facet-item-"+CleanName(a.Name)+"__"+CleanName("(no info)");for(var m=r.length-1;m>-1;m-=1)if(r[m].itemId==v){r[m].count+=1,d=!0;break}d||r.push({itemId:v,itemValue:"(no info)",facet:a.Name,count:1})}}if(a.IsWordWheelVisible)for(var l=0,c=n.Facets.length;l<c;l++){var h=n.Facets[l];if(h.Name==a.Name)for(var p=0;p<h.FacetValues.length;p++)a.Type==PivotViewer.Models.FacetType.String&&u.push({Facet:h.Name,Value:h.FacetValues[p].Value})}}}var b=["<div class='pv-filterpanel-accordion'>"],w=[];for(var t=0;t<P.FacetCategories.length;t++)P.FacetCategories[t].IsFilterVisible&&(b[t+1]="<h3><a href='#' title="+P.FacetCategories[t].Name+">",b[t+1]+=P.FacetCategories[t].Name,b[t+1]+="</a><div class='pv-filterpanel-accordion-heading-clear' facetType='"+P.FacetCategories[t].Type+"'>&nbsp;</div></h3>",b[t+1]+="<div style='height:30%' id='pv-cat-"+CleanName(P.FacetCategories[t].Name)+"'>",P.FacetCategories[t].Type==PivotViewer.Models.FacetType.DateTime?b[t+1]+=CreateDateTimeFacet(P.FacetCategories[t].Name):P.FacetCategories[t].Type==PivotViewer.Models.FacetType.String||P.FacetCategories[t].Type==PivotViewer.Models.FacetType.Link?(P.FacetCategories[t].CustomSort!=undefined||P.FacetCategories[t].CustomSort!=null?b[t+1]+="<span class='pv-filterpanel-accordion-facet-sort' customSort='"+P.FacetCategories[t].CustomSort.Name+"'>Sort: "+P.FacetCategories[t].CustomSort.Name+"</span>":b[t+1]+="<span class='pv-filterpanel-accordion-facet-sort'>Sort: A-Z</span>",b[t+1]+=CreateStringFacet(P.FacetCategories[t].Name)):P.FacetCategories[t].Type==PivotViewer.Models.FacetType.Number&&(b[t+1]+="<div id='pv-filterpanel-category-numberitem-"+CleanName(P.FacetCategories[t].Name)+"'></div>"),b[t+1]+="</div>",w[t]="<option value='"+CleanName(P.FacetCategories[t].Name)+"' label='"+P.FacetCategories[t].Name+"'>"+P.FacetCategories[t].Name+"</option>");b[b.length]="</div>",e(".pv-filterpanel").append(b.join(""));for(var t=0;t<P.FacetCategories.length;t++)P.FacetCategories[t].IsFilterVisible&&SortFacetItems(P.FacetCategories[t].Name);e(".pv-filterpanel-accordion").css("height",e(".pv-filterpanel").height()-e(".pv-filterpanel-search").height()-75+"px"),e(".pv-filterpanel-accordion").accordion({}),e(".pv-toolbarpanel-sortcontrols").append('<select class="pv-toolbarpanel-sort">'+w.join("")+"</select>");for(var t=0;t<s.length;t++)CreateNumberFacet(CleanName(s[t].Facet),s[t].Values)},CreateDateTimeFacet=function(e){var t=["<ul class='pv-filterpanel-accordion-facet-list'>"];for(var n=0;n<o.length;n++)o[n].facet==e&&(t[n+1]="<li class='pv-filterpanel-accordion-facet-list-item'  id='"+o[n].itemId+"'>",t[n+1]+="<input itemvalue='"+CleanName(o[n].itemValue)+"' itemfacet='"+CleanName(e)+"' class='pv-facet-facetitem' type='checkbox' />",t[n+1]+="<span class='pv-facet-facetitem-label' title='"+o[n].itemValue+"'>"+o[n].itemValue+"</span>",t[n+1]+="<span class='pv-facet-facetitem-count'>0</span>",t[n+1]+="</li>");return t[t.length]="</ul>",t.join("")},CreateStringFacet=function(e){var t=["<ul class='pv-filterpanel-accordion-facet-list'>"];for(var n=0;n<r.length;n++)r[n].facet==e&&(t[n+1]="<li class='pv-filterpanel-accordion-facet-list-item'  id='"+r[n].itemId+"'>",t[n+1]+="<input itemvalue='"+CleanName(r[n].itemValue)+"' itemfacet='"+CleanName(e)+"' class='pv-facet-facetitem' type='checkbox' />",t[n+1]+="<span class='pv-facet-facetitem-label' title='"+r[n].itemValue+"'>"+r[n].itemValue+"</span>",t[n+1]+="<span class='pv-facet-facetitem-count'>0</span>",t[n+1]+="</li>");return t[t.length]="</ul>",t.join("")},CreateNumberFacet=function(t,n){var r=165,i=80,s=e("#pv-filterpanel-category-numberitem-"+PivotViewer.Utils.EscapeMetaChars(t));s.empty(),s.append("<span class='pv-filterpanel-numericslider-range-val'>&nbsp;</span>");var o="<svg class='pv-filterpanel-accordion-facet-chart' width='"+r+"' height='"+i+"'>",u=PivotViewer.Utils.Histogram(n),a=.5+r/u.BinCount|0,f=0;for(var l=0,c=u.Histogram.length;l<c;l++)f=f<u.Histogram[l].length?u.Histogram[l].length:f;for(var l=0,c=u.Histogram.length;l<c;l++){var h=.5+i/(f/u.Histogram[l].length)|0,p=.5+a*l|0;o+="<rect x='"+p+"' y='"+(i-h)+"' width='"+a+"' height='"+h+"'></rect>"}s.append(o+"</svg>");var d=e("#pv-filterpanel-category-numberitem-"+PivotViewer.Utils.EscapeMetaChars(t));d.append('</span><div id="pv-filterpanel-numericslider-'+t+'" class="pv-filterpanel-numericslider"></div><span class="pv-filterpanel-numericslider-range-min">'+u.Min+'</span><span class="pv-filterpanel-numericslider-range-max">'+u.Max+"</span>");var v=e("#pv-filterpanel-numericslider-"+PivotViewer.Utils.EscapeMetaChars(t));v.slider({range:!0,min:u.Min,max:u.Max,values:[u.Min,u.Max],slide:function(t,n){e(this).parent().find(".pv-filterpanel-numericslider-range-val").text(n.values[0]+" - "+n.values[1])},stop:function(t,n){var r=e(this),i=r.slider("option","min"),s=r.slider("option","max");n.values[0]>i||n.values[1]<s?r.parent().parent().prev().find(".pv-filterpanel-accordion-heading-clear").css("visibility","visible"):n.values[0]==i&&n.values[1]==s&&r.parent().parent().prev().find(".pv-filterpanel-accordion-heading-clear").css("visibility","hidden"),FilterCollection(!1)}})},CreateViews=function(){var t=e(".pv-viewpanel"),r=O.width(),i=e(".pv-mainpanel").height(),s=e(".pv-filterpanel").width()+18,o=4;n.push(new PivotViewer.Views.GridView),n.push(new PivotViewer.Views.GraphView),n.push(new PivotViewer.Views.TableView),n.push(new PivotViewer.Views.MapView);for(var u=0;u<n.length;u++)try{if(n[u]instanceof PivotViewer.Views.IPivotViewerView)n[u].Setup(r,i,s,o,h.GetMaxTileRatio()),t.append("<div class='pv-viewpanel-view' id='pv-viewpanel-view-"+u+"'>"+n[u].GetUI()+"</div>"),e(".pv-toolbarpanel-viewcontrols").append("<div class='pv-toolbarpanel-view' id='pv-toolbarpanel-view-"+u+"' title='"+n[u].GetViewName()+"'><img id='pv-viewpanel-view-"+u+"-image' src='"+n[u].GetButtonImage()+"' alt='"+n[u].GetViewName()+"' /></div>");else{var a="";a+="View does not inherit from PivotViewer.Views.IPivotViewerView<br>",e(".pv-wrapper").append('<div id="pv-view-error" class="pv-modal-dialog"><div><a href="#pv-modal-dialog-close" title="Close" class="pv-modal-dialog-close">X</a><h2>HTML5 PivotViewer</h2><p>'+a+"</p></div></div>"),window.open("#pv-view-error","_self")}}catch(f){alert(f.Message)}n[2].SetFacetCategories(P),n[3].SetFacetCategories(P)},global.setMapReady=function(){_=!0,SelectView(3,!0)},SelectView=function(t,r){if(t==3&&!_&&D){var i=document.createElement("script");i.type="text/javascript",i.src="https://maps.googleapis.com/maps/api/js?key="+D+"&sensor=false&callback=global.setMapReady",document.body.appendChild(i);return}if(t==3&&!D){var s="";s+='Viewing the data on Google maps requires an API key. This can be obtained from <a href="https://code.google.com/apis/console/?noredirect" target="_blank">here</a>',e(".pv-wrapper").append('<div id="pv-nomapkey-error" class="pv-modal-dialog"><div><a href="#pv-modal-dialog-close" title="Close" class="pv-modal-dialog-close">X</a><h2>HTML5 PivotViewer</h2><p>'+s+"</p></div></div>");var o=setTimeout(function(){window.open("#pv-nomapkey-error","_self")},1e3);return}for(var u=0;u<n.length;u++)t!=u&&(e("#pv-viewpanel-view-"+u+"-image").attr("src",n[u].GetButtonImage()),n[u].Deactivate(),n[u].init=!1);e("#pv-viewpanel-view-"+t+"-image").attr("src",n[t].GetButtonImageSelected()),l==1&&(t==2||t==3)&&(n[0].Activate(),n[0].init=r,l=0,FilterCollection(!0)),n[t].Activate(),n[t].init=r,l=t,t==1&&(e.publish("/PivotViewer/Views/Item/Selected",[{id:"",bkt:0}]),v=""),FilterCollection(!0)},SortFacetItems=function(t){var n=e("#pv-cat-"+PivotViewer.Utils.EscapeMetaChars(CleanName(t))+" ul"),r=n.prev().text().replace("Sort: ",""),i=n.children("li").get();if(r=="A-Z")i.sort(function(t,n){var r=e(t).children().first().attr("itemvalue"),i=e(n).children().first().attr("itemvalue");return r<i?1:r>i?-1:0});else if(r=="Quantity")i.sort(function(t,n){var r=parseInt(e(t).children(".pv-facet-facetitem-count").text()),i=parseInt(e(n).children(".pv-facet-facetitem-count").text());return r<i?-1:r>i?1:0});else{var s=P.GetFacetCategoryByName(t);if(s.CustomSort!=undefined){var o=[];for(var u=s.CustomSort.SortValues.length-1;u>-1;u-=1)for(var a=0;a<i.length;a++)s.CustomSort.SortValues[u]==e(i[a]).children(".pv-facet-facetitem-label").text()&&(o.push(i[a]),found=!0);i=o}}for(var u=0;u<i.length;u++)n.prepend(i[u])},ApplyViewerState=function(){A.Facet!=null&&(e(".pv-toolbarpanel-sort option[value="+CleanName(A.Facet)+"]").prop("selected","selected"),N=e(".pv-toolbarpanel-sort :selected").attr("label"),Debug.Log("current sort "+N));for(var t=0,n=A.Filters.length;t<n;t++)for(var r=0,i=A.Filters[t].Predicates.length;r<i;r++){var s=A.Filters[t].Predicates[r].Operator;if(s=="GT"||s=="GE"||s=="LT"||s=="LE"){var o=e("#pv-filterpanel-numericslider-"+CleanName(A.Filters[t].Facet)),u=parseFloat(A.Filters[t].Predicates[r].Value);switch(s){case"GT":o.slider("values",0,u+1);break;case"GE":o.slider("values",0,u);break;case"LT":o.slider("values",1,u-1);break;case"LE":o.slider("values",1,u)}o.parent().find(".pv-filterpanel-numericslider-range-val").text(o.slider("values",0)+" - "+o.slider("values",1)),o.parent().parent().prev().find(".pv-filterpanel-accordion-heading-clear").css("visibility","visible")}else s=="EQ"?SelectStringFacetItem(CleanName(A.Filters[t].Facet),CleanName(A.Filters[t].Predicates[r].Value)):s=="NT"&&SelectStringFacetItem(CleanName(A.Filters[t].Facet),"_no_info_")}},SelectStringFacetItem=function(t,n){var r=e('.pv-facet-facetitem[itemfacet="'+t+'"][itemvalue="'+n+'"]');r.prop("checked",!0),r.parent().parent().parent().prev().find(".pv-filterpanel-accordion-heading-clear").css("visibility","visible")},FilterCollection=function(t){var r=[],i=[],s=[],o=e(".pv-toolbarpanel-sort option:selected").attr("label");Debug.Log("sort "+o),t||(v="");var u=e(".pv-facet-facetitem:checked");e(".pv-filterpanel-clearall").css("visibility","hidden");var c=[];for(var m=0;m<u.length;m++){var T=M[e(u[m]).attr("itemfacet")],N=M[e(u[m]).attr("itemvalue")],C=!1;for(var k=0;k<c.length;k++)c[k].facet==T&&(c[k].facetValue.push(N),C=!0);C||c.push({facet:T,facetValue:[N]}),e.inArray(T,s)<0&&s.push(T)}var L=[];for(var m=0,A=P.FacetCategories.length;m<A;m++)if(P.FacetCategories[m].Type==PivotViewer.Models.FacetType.Number){var O=e("#pv-filterpanel-category-numberitem-"+CleanName(P.FacetCategories[m].Name)),_=e(O).find(".pv-filterpanel-numericslider");if(_.length>0){var D=_.slider("values"),H=_.slider("option","max"),B=_.slider("option","min");if(D[0]!=B||D[1]!=H){var T=P.FacetCategories[m].Name;L.push({facet:T,selectedMin:D[0],selectedMax:D[1],rangeMin:B,rangeMax:H}),e.inArray(T,s)<0&&s.push(T)}}}for(var m=0,A=P.Items.length;m<A;m++){var j=0;for(var F=0,I=c.length;F<I;F++)for(var q=0,R=c[F].facetValue.length;q<R;q++)if(c[F].facetValue[q]=="(no info)"){var U=!1;for(var k=0,z=P.Items[m].Facets.length;k<z;k++)P.Items[m].Facets[k].Name==c[F].facet&&(U=!0);U==0&&j++}for(var k=0,z=P.Items[m].Facets.length;k<z;k++)for(var F=0,I=c.length;F<I;F++){var W=0;if(P.Items[m].Facets[k].Name==c[F].facet)for(var X=0,V=P.Items[m].Facets[k].FacetValues.length;X<V;X++)for(var q=0,R=c[F].facetValue.length;q<R;q++)P.Items[m].Facets[k].FacetValues[X].Value==c[F].facetValue[q]&&W++;W>0&&j++}if(j!=c.length)continue;for(var F=0,I=L.length;F<I;F++)if(L[F].selectedMin=="(no info)"){var U=!1;for(var k=0,z=P.Items[m].Facets.length;k<z;k++)P.Items[m].Facets[k].Name==L[F].facet&&(U=!0);U==0&&j++}for(var k=0,z=P.Items[m].Facets.length;k<z;k++)for(var F=0,I=L.length;F<I;F++)if(P.Items[m].Facets[k].Name==L[F].facet)for(var X=0,V=P.Items[m].Facets[k].FacetValues.length;X<V;X++){var J=parseFloat(P.Items[m].Facets[k].FacetValues[X].Value);!isNaN(J)&&J>=L[F].selectedMin&&J<=L[F].selectedMax&&j++}if(j!=c.length+L.length)continue;r.push(P.Items[m].Id),c.length+L.length>0&&e(".pv-filterpanel-clearall").css("visibility","visible")}f=L,a=c,e(".pv-viewpanel-view").hide(),e("#pv-viewpanel-view-"+l).show(),FilterFacets(r,s),UpdateBreadcrumbNavigation(c,L),h.SetCircularEasingBoth(),x?(n[l].Filter(p,r,o,c,t,v),(l==2||l==3)&&!t&&n[0].Filter(p,r,o,c,!1,"")):(l==2?(n[l].SetSelectedFacet(y),n[l].Filter(p,r,o,c,t,g)):l==3?(n[l].SetMapInitCentreX(b),n[l].SetMapInitCentreY(w),n[l].SetMapInitType(E),n[l].SetMapInitZoom(S),n[l].applyBookmark=!0,n[l].Filter(p,r,o,c,t,g)):n[l].Filter(p,r,o,c,t,v),x=!0);var K=[];if(n[l].GetViewName()=="Graph View")K=n[l].GetSortedFilter();else for(var m=0;m<n[l].tiles.length;m++){var Q=e.inArray(n[l].tiles[m].facetItem.Id,r);if(Q>=0){var G=new Object;G.Id=n[l].tiles[m].facetItem.Id,G.Bucket=0,K.push(G)}}d=K,UpdateBookmark(),DeselectInfoPanel()},FilterFacets=function(t,n){if(t.length==P.Items.length){for(var i=o.length-1;i>-1;i-=1){var u=e("#"+PivotViewer.Utils.EscapeMetaChars(o[i].itemId));u.show(),u.find("span").last().text(o[i].count)}for(var i=r.length-1;i>-1;i-=1){var u=e("#"+PivotViewer.Utils.EscapeMetaChars(r[i].itemId));u.show(),u.find("span").last().text(r[i].count)}for(var i=0;i<s.length;i++)CreateNumberFacet(CleanName(s[i].Facet),s[i].Values);return}var a=[],f=[],l=[];for(var i=t.length-1;i>-1;i-=1){var u=P.GetItemById(t[i]);for(var c=0;c<P.FacetCategories.length;c++)if(P.FacetCategories[c].IsFilterVisible){var h=!1;for(var p=u.Facets.length-1;p>-1;p-=1)if(u.Facets[p].Name==P.FacetCategories[c].Name){if(e.inArray(u.Facets[p].Name,n)<0){var d=P.GetFacetCategoryByName(u.Facets[p].Name);if(d.IsFilterVisible)for(var v=u.Facets[p].FacetValues.length-1;v>-1;v-=1)if(d.Type==PivotViewer.Models.FacetType.String){var m={item:"#"+PivotViewer.Utils.EscapeMetaChars("pv-facet-item-"+CleanName(u.Facets[p].Name)+"__"+CleanName(u.Facets[p].FacetValues[v].Value)),count:1},g=!1;for(var y=a.length-1;y>-1;y-=1)if(a[y].item==m.item){a[y].count+=1,g=!0;break}g||a.push(m)}else if(d.Type==PivotViewer.Models.FacetType.Number){var b=!1;for(var y=0;y<f.length;y++)if(f[y].Facet==u.Facets[p].Name){f[y].Values.push(u.Facets[p].FacetValues[v].Value),b=!0;break}b||f.push({Facet:u.Facets[p].Name,Values:[u.Facets[p].FacetValues[v].Value]})}}h=!0}if(!h){var m={item:"#"+PivotViewer.Utils.EscapeMetaChars("pv-facet-item-"+CleanName(P.FacetCategories[c].Name)+"__"+CleanName("(no info)")),count:1},g=!1;for(var y=a.length-1;y>-1;y-=1)if(a[y].item==m.item){a[y].count+=1,g=!0;break}g||a.push(m)}}}for(var i=r.length-1;i>-1;i-=1)if(e.inArray(r[i].facet,n)<0){var g=!1;for(var p=a.length-1;p>-1;p-=1)if(a[p].item==r[i].itemId){g=!0;break}g||e("#"+PivotViewer.Utils.EscapeMetaChars(r[i].itemId)).hide()}else e("#"+PivotViewer.Utils.EscapeMetaChars(r[i].itemId)).find("span").last().text(r[i].count);for(var i=a.length-1;i>-1;i-=1){var w=e(a[i].item);if(w.length>0){w.show();var E=w.find("span").last();E.text(a[i].count)}}for(var i=0;i<f.length;i++)CreateNumberFacet(CleanName(f[i].Facet),f[i].Values)},UpdateBreadcrumbNavigation=function(t,n){var r=e(".pv-toolbarpanel-facetbreadcrumb");r.empty();if(t.length==0&&n.length==0)return;var i="|";for(var s=0,o=t.length;s<o;s++)i+="<span class='pv-toolbarpanel-facetbreadcrumb-facet'>"+t[s].facet+":</span><span class='pv-toolbarpanel-facetbreadcrumb-values'>",i+=t[s].facetValue.join(", "),i+="</span><span class='pv-toolbarpanel-facetbreadcrumb-separator'>&gt;</span>";for(var s=0,o=n.length;s<o;s++)i+="<span class='pv-toolbarpanel-facetbreadcrumb-facet'>"+n[s].facet+":</span><span class='pv-toolbarpanel-facetbreadcrumb-values'>",n[s].selectedMin==n[s].rangeMin?i+="Under "+n[s].selectedMax:n[s].selectedMax==n[s].rangeMax?i+="Over "+n[s].selectedMin:i+=n[s].selectedMin+" - "+n[s].selectedMax,i+="</span><span class='pv-toolbarpanel-facetbreadcrumb-separator'>&gt;</span>"
;r.append(i)},DeselectInfoPanel=function(){e(".pv-infopanel").fadeOut(),e(".pv-infopanel-heading").empty(),e(".pv-infopanel-details").empty()},GetItemIds=function(e,t){var n=[];for(var r=0;r<P.Items.length;r++){var i=!1;for(var s=0;s<P.Items[r].Facets.length;s++)if(P.Items[r].Facets[s].Name==e){for(var o=0;o<P.Items[r].Facets[s].FacetValues.length;o++)t==P.Items[r].Facets[s].FacetValues[o].Value&&n.push(P.Items[r].Id);i=!0}!i&&t=="(no info)"&&n.push(P.Items[r].Id)}return n},GetItem=function(e){for(var t=0;t<P.Items.length;t++)if(P.Items[t].Id==e)return P.Items[t];return null},UpdateBookmark=function(){var e="#",t=l+1;e+="$view$="+t,N&&(e+="&$facet0$="+N),v&&(e+="&$selection$="+v.Id),l==2&&n[l].GetSelectedFacet()&&(e+="&$tableFacet$="+n[l].GetSelectedFacet()),l==3&&(n[l].GetMapCentreX()&&(e+="&$mapCentreX$="+n[l].GetMapCentreX()),n[l].GetMapCentreY()&&(e+="&$mapCentreY$="+n[l].GetMapCentreY()),n[l].GetMapType()&&(e+="&$mapType$="+n[l].GetMapType()),n[l].GetMapZoom()&&(e+="&$mapZoom$="+n[l].GetMapZoom()));var r=P.CollectionName;f.length+a.length>0&&(r+=" | ");if(a.length>0)for(i=0;i<a.length;i++){for(j=0;j<a[i].facetValue.length;j++)e+="&",e+=a[i].facet,e+="=EQ."+a[i].facetValue[j];r+=a[i].facet+": ",r+=a[i].facetValue.join(", "),i<a.length-1&&(r+=" > ")}if(f.length>0)for(i=0;i<f.length;i++)e+="&",e+=f[i].facet,r+=f[i].facet+": ",f[i].selectedMin==f[i].rangeMin?(e+="=LE."+f[i].selectedMax,r+="Under "+f[i].selectedMax):f[i].selectedMax==f[i].rangeMax?(e+="=GE."+f[i].selectedMin,r+="Over "+f[i].selectedMin):(e+="=GE."+f[i].selectedMin+"_LE."+f[i].selectedMax,r+="Between "+f[i].selectedMin+" and "+f[i].selectedMax),i<f.length-1&&(r+=" > ");typeof SetBookmark!=undefined&&typeof SetBookmark=="function"&&SetBookmark(P.CXMLBaseNoProxy,e,r)},CleanName=function(e){return name=e.replace(/[^\w]/gi,"_"),M[name]=e,name},e.subscribe("/PivotViewer/Models/Collection/Loaded",function(e){InitTileCollection()}),e.subscribe("/PivotViewer/ImageController/Collection/Loaded",function(t){InitPivotViewer();var n=e(".pv-filterpanel");n.append("<div class='pv-filterpanel-version'><a href=\"#pv-open-version\">About HTHL5 PivotViewer</a></div>"),n.append('<div id="pv-open-version" class="pv-modal-dialog"><div><a href="#pv-modal-dialog-close" title="Close" class="pv-modal-dialog-close">X</a><h2>HTML5 PivotViewer</h2><p>Version: '+e(PivotViewer)[0].Version+'</p><p>The sources are available on <a href="https://github.com/openlink/html5pivotviewer" target="_blank">github</a></p></div></div>')}),e.subscribe("/PivotViewer/Views/Item/Selected",function(t){if(t.id===undefined||t.id===null||t.id===""){DeselectInfoPanel(),v="",l==2&&n[l].Selected(v.Id),UpdateBookmark();return}var r=GetItem(t.id);if(r!=null){var i=!0;e(".pv-infopanel-heading").empty(),e(".pv-infopanel-heading").append('<a href="'+r.Href+'" target="_blank">'+r.Name+"</a></div>");var s=e(".pv-infopanel-details");s.empty(),r.Description!=undefined&&r.Description.length>0&&s.append("<div class='pv-infopanel-detail-description' style='height:100px;'>"+r.Description+"</div><div class='pv-infopanel-detail-description-more'>More</div>"),r.Id==d[0].Id&&r==d[d.length-1]?(e(".pv-infopanel-controls-navright").hide(),e(".pv-infopanel-controls-navrightdisabled").show(),e(".pv-infopanel-controls-navleft").hide(),e(".pv-infopanel-controls-navleftdisabled").show()):r.Id==d[0].Id?(e(".pv-infopanel-controls-navleft").hide(),e(".pv-infopanel-controls-navleftdisabled").show(),e(".pv-infopanel-controls-navright").show(),e(".pv-infopanel-controls-navrightdisabled").hide()):r.Id==d[d.length-1].Id?(e(".pv-infopanel-controls-navright").hide(),e(".pv-infopanel-controls-navrightdisabled").show(),e(".pv-infopanel-controls-navleft").show(),e(".pv-infopanel-controls-navleftdisabled").hide()):(e(".pv-infopanel-controls-navright").show(),e(".pv-infopanel-controls-navrightdisabled").hide(),e(".pv-infopanel-controls-navleft").show(),e(".pv-infopanel-controls-navleftdisabled").hide());var o=[],u=0;for(var a=0;a<r.Facets.length;a++){var f=!1,c=!1;for(var h=0;h<P.FacetCategories.length;h++)if(P.FacetCategories[h].Name==r.Facets[a].Name&&P.FacetCategories[h].IsMetaDataVisible){f=!0,c=P.FacetCategories[h].IsFilterVisible;break}if(f){o[u]="<div class='pv-infopanel-detail "+(i?"detail-dark":"detail-light")+"'><div class='pv-infopanel-detail-item detail-item-title' pv-detail-item-title='"+r.Facets[a].Name+"'>"+r.Facets[a].Name+"</div>";for(var h=0;h<r.Facets[a].FacetValues.length;h++)o[u]+="<div pv-detail-item-value='"+r.Facets[a].FacetValues[h].Value+"' class='pv-infopanel-detail-item detail-item-value"+(c?" detail-item-value-filter":"")+"'>",r.Facets[a].FacetValues[h].Href!=null?o[u]+="<a class='detail-item-link' href='"+r.Facets[a].FacetValues[h].Href+"'>"+r.Facets[a].FacetValues[h].Value+"</a>":o[u]+=r.Facets[a].FacetValues[h].Value,o[u]+="</div>";o[u]+="</div>",u++,i=!i}}if(r.Links.length>0){e(".pv-infopanel-related").empty();for(var p=0;p<r.Links.length;p++)e(".pv-infopanel-related").append("<a href='"+r.Links[p].Href+"'>"+r.Links[p].Name+"</a><br>")}s.append(o.join("")),e(".pv-infopanel").fadeIn(),s.css("height",e(".pv-infopanel").height()-(e(".pv-infopanel-controls").height()+e(".pv-infopanel-heading").height()+e(".pv-infopanel-copyright").height()+e(".pv-infopanel-related").height())-20+"px"),v=r,m=t.bkt,l==2&&n[l].Selected(v.Id),l==3&&n[l].RedrawMarkers(v.Id),UpdateBookmark();return}}),e.subscribe("/PivotViewer/Views/Item/Filtered",function(t){if(t==undefined||t==null)return;if(t.ClearFacetFilters==1)for(var n=0,r=P.FacetCategories.length;n<r;n++)if(P.FacetCategories[n].Name==t.Facet&&(P.FacetCategories[n].Type==PivotViewer.Models.FacetType.String||P.FacetCategories[n].Type==PivotViewer.Models.FacetType.DateTime)){var i=e('.pv-facet-facetitem[itemfacet="'+CleanName(t.Facet)+'"]');for(var s=0;s<i.length;s++)e(i[s]).prop("checked",!1)}for(var n=0,r=P.FacetCategories.length;n<r;n++){if(P.FacetCategories[n].Name==t.Facet&&(P.FacetCategories[n].Type==PivotViewer.Models.FacetType.String||P.FacetCategories[n].Type==PivotViewer.Models.FacetType.DateTime))if(t.Values)for(var s=0;s<t.Values.length;s++){var o=e(PivotViewer.Utils.EscapeMetaChars("#pv-facet-item-"+CleanName(t.Facet)+"__"+CleanName(t.Values[s]))+" input");o.prop("checked",!0),FacetItemClick(o[0])}else{var o=e(PivotViewer.Utils.EscapeMetaChars("#pv-facet-item-"+CleanName(t.Facet)+"__"+CleanName(t.Item))+" input");o.prop("checked",!0),FacetItemClick(o[0])}if(P.FacetCategories[n].Name==t.Facet&&P.FacetCategories[n].Type==PivotViewer.Models.FacetType.Number){var u=e("#pv-filterpanel-numericslider-"+PivotViewer.Utils.EscapeMetaChars(t.Facet));FacetSliderDrag(u,t.Item,t.MaxRange)}}}),e.subscribe("/PivotViewer/Views/Item/Updated",function(){UpdateBookmark()}),e.subscribe("/PivotViewer/Views/ChangeTo/Grid",function(n){var r="";for(t=0;t<p.length;t++)if(p[t].facetItem==n.Item){r=p[t];break}r&&e.publish("/PivotViewer/Views/Canvas/Click",[{x:r._locations[r.selectedLoc].destinationx+r.destinationwidth/2,y:r._locations[r.selectedLoc].destinationy+r.destinationheight/2}])}),e.subscribe("/PivotViewer/Views/Update/GridSelection",function(e){n[0].handleSelection(e.selectedItem,e.selectedTile)}),AttachEventHandlers=function(){e(".pv-toolbarpanel-view").on("click",function(e){var t=this.id.substring(this.id.lastIndexOf("-")+1,this.id.length);t!=null&&SelectView(parseInt(t),!1)}),e(".pv-toolbarpanel-sort").on("change",function(t){N=e(".pv-toolbarpanel-sort option:selected").attr("label"),Debug.Log("sort change _currentSort "+N),FilterCollection(!1)}),e(".pv-filterpanel-accordion-facet-sort").on("click",function(t){var n=e(this),r=n.text(),i=n.parent().prev().children("a").text(),s=n.attr("customSort");r=="Sort: A-Z"?e(this).text("Sort: Quantity"):r=="Sort: Quantity"&&s==undefined?e(this).text("Sort: A-Z"):r=="Sort: Quantity"?e(this).text("Sort: "+s):e(this).text("Sort: A-Z"),SortFacetItems(i)}),e(".pv-facet-facetitem").on("click",function(e){FacetItemClick(this)}),e(".pv-facet-facetitem-label").on("click",function(t){var n=e(this).prev(),r=e(this.parentElement.parentElement).find(":checked");n.prop("checked")==1&&r.length<=1?n.prop("checked",!1):n.prop("checked",!0);for(var i=r.length-1;i>-1;i-=1)r[i].getAttribute("itemvalue")!=n[0].getAttribute("itemvalue")&&(r[i].checked=!1);FacetItemClick(n[0])}),e(".pv-filterpanel-clearall").on("click",function(t){var n=e(".pv-facet-facetitem:checked");for(var r=0;r<n.length;r++)e(n[r]).prop("checked",!1);var i=e(".pv-filterpanel-numericslider");for(var r=0;r<i.length;r++){var s=e(i[r]),o=s.slider("option","min"),u=s.slider("option","max");s.slider("values",0,o),s.slider("values",1,u),s.prev().prev().html("&nbsp;")}e(".pv-filterpanel-search").val(""),e(".pv-filterpanel-accordion-heading-clear").css("visibility","hidden"),FilterCollection(!1)}),e(".pv-filterpanel-accordion-heading-clear").on("click",function(t){var n=this.attributes.facetType.value;if(n=="DateTime"){var r=e(this.parentElement).next().find(".pv-facet-facetitem:checked");for(var i=0;i<r.length;i++)e(r[i]).prop("checked",!1)}else if(n=="String"){var r=e(this.parentElement).next().find(".pv-facet-facetitem:checked");for(var i=0;i<r.length;i++)e(r[i]).prop("checked",!1)}else if(n=="Number"){var s=e(this.parentElement).next().find(".pv-filterpanel-numericslider"),o=s.slider("option","min"),u=s.slider("option","max");s.slider("values",0,o),s.slider("values",1,u),s.prev().prev().html("&nbsp;")}FilterCollection(!1),e(this).css("visibility","hidden")}),e(".ui-slider-range").on("mousedown",function(e){}),e(".pv-infopanel-details").on("click",".detail-item-value-filter",function(t){return e.publish("/PivotViewer/Views/Item/Filtered",[{Facet:e(this).parent().children().attr("pv-detail-item-title"),Item:this.getAttribute("pv-detail-item-value"),Values:null,ClearFacetFilters:!0}]),!1}),e(".pv-infopanel-details").on("click",".pv-infopanel-detail-description-more",function(t){var n=e(this),r=e(this).prev();n.text()=="More"?(r.css("height",""),e(this).text("Less")):(r.css("height","100px"),e(this).text("More"))}),e(".pv-infopanel-controls-navleft").on("click",function(t){for(var r=0;r<d.length;r++)if(d[r].Id==v.Id&&d[r].Bucket==m){r>=0&&e.publish("/PivotViewer/Views/Item/Selected",[{id:d[r-1].Id,bkt:d[r-1].Bucket}]);if(l==0||l==1)for(var i=0;i<p.length;i++)p[i].facetItem.Id==d[r-1].Id?(p[i].Selected(!0),selectedCol=n[l].GetSelectedCol(p[i],d[r-1].Bucket),selectedRow=n[l].GetSelectedRow(p[i],d[r-1].Bucket),n[l].CentreOnSelectedTile(selectedCol,selectedRow)):p[i].Selected(!1);break}}),e(".pv-infopanel-controls-navright").on("click",function(t){for(var r=0;r<d.length;r++)if(d[r].Id==v.Id&&d[r].Bucket==m){if(r<d.length){e.publish("/PivotViewer/Views/Item/Selected",[{id:d[r+1].Id,bkt:d[r+1].Bucket}]);if(l==0||l==1)for(var i=0;i<p.length;i++)p[i].facetItem.Id==d[r+1].Id?(p[i].Selected(!0),selectedCol=n[l].GetSelectedCol(p[i],d[r+1].Bucket),selectedRow=n[l].GetSelectedRow(p[i],d[r+1].Bucket),n[l].CentreOnSelectedTile(selectedCol,selectedRow)):p[i].Selected(!1)}break}}),e(".pv-filterpanel-search").on("keyup",function(t){var n=!1,r=[],i=e(".pv-filterpanel-search-autocomplete"),s=FilterCollection,o=SelectStringFacetItem;i.empty();if(t.keyCode==27){e(t.target).blur();return}for(var a=0,f=u.length;a<f;a++){var l=u[a].Value.toLowerCase();l.indexOf(t.target.value.toLowerCase())>=0&&e.inArray(l,r)==-1&&(r.push(l),i.append('<span facet="'+u[a].Facet+'">'+u[a].Value+"</span>"),t.keyCode==13&&(SelectStringFacetItem(CleanName(u[a].Facet),CleanName(u[a].Value)),n=!0))}e(".pv-filterpanel-search-autocomplete > span").on("mousedown",function(t){t.preventDefault(),e(".pv-filterpanel-search").val(t.target.textContent),e(".pv-filterpanel-search-autocomplete").hide(),o(CleanName(t.target.attributes[0].value),CleanName(t.target.textContent)),s()}),r.length>0&&i.show(),n&&FilterCollection(!1)}),e(".pv-filterpanel-search").on("blur",function(t){t.target.value="",e(".pv-filterpanel-search-autocomplete").hide()});var t=e(".pv-viewarea-canvas");t.on("mouseup",function(t){var n=e(this).offset(),r=t.clientX-n.left,i=t.clientY-n.top;(!L||L.x==0&&L.y==0)&&e.publish("/PivotViewer/Views/Canvas/Click",[{x:r,y:i}]),k=null,L=!1}),t.on("mouseout",function(e){k=null,L=!1}),t.on("mousedown",function(t){var n=e(this).offset(),r=t.clientX-n.left,i=t.clientY-n.top;k={x:r,y:i}}),t.on("mousemove",function(t){var n=e(this).offset(),r=t.clientX-n.left,i=t.clientY-n.top;k==null?e.publish("/PivotViewer/Views/Canvas/Hover",[{x:r,y:i}]):(L={x:r-k.x,y:i-k.y},k={x:r,y:i},e.publish("/PivotViewer/Views/Canvas/Drag",[L]))}),t.on("mousewheel",function(t,n){var r=e(this).offset(),i=t.clientX-r.left,s=t.clientY-r.top;h.SetQuarticEasingOut(),h.DrawHelpers([{x:i,y:s}]);var o=e(".pv-toolbarpanel-zoomslider").slider("option","value");n>0?o=o<5?5:o+5:n<0&&(o-=5),o=Math.max(0,Math.min(100,o)),e(".pv-toolbarpanel-zoomslider").slider("option","value",o)}),t.on("touchstart",function(t){var n=t.originalEvent,r=e(this).offset(),i=n.touches[0].pageX-r.left,s=n.touches[0].pageY-r.top;k={x:i,y:s}}),t.on("touchmove",function(t){try{var n=t.originalEvent;t.preventDefault();if(n.touches.length>1){t.preventDefault();var r=1e7,i=1e7,s=0,o=0,u=[];for(var a=0;a<n.touches.length;a++)u.push({x:n.touches[a].pageX,y:n.touches[a].pageY}),n.touches[a].pageX<r&&(r=n.touches[a].pageX),n.touches[a].pageX>s&&(s=n.touches[a].pageX),n.touches[a].pageY<i&&(i=n.touches[a].pageY),n.touches[a].pageY>o&&(o=n.touches[a].pageY);var f=(r+s)/2,l=(i+o)/2;h.SetLinearEasingBoth(),u.push({x:f,y:l}),h.DrawHelpers(u),h.DrawHelperText("Scale: "+n.scale),e.publish("/PivotViewer/Views/Canvas/Zoom",[{x:f,y:l,scale:n.scale}]);return}var c=e(this).offset(),p=n.touches[0].pageX-c.left,d=n.touches[0].pageY-c.top;L={x:p-k.x,y:d-k.y},k={x:p,y:d},e.publish("/PivotViewer/Views/Canvas/Drag",[L])}catch(v){Debug.Log(v.message)}}),t.on("touchend",function(t){var n=t.originalEvent;if(n.touches.length==1&&k==null){var r=e(this).offset(),i=n.touches[0].pageX-r.left,s=n.touches[0].pageY-r.top;(!L||L.x==0&&L.y==0)&&e.publish("/PivotViewer/Views/Canvas/Click",[{x:i,y:s}])}k=null,L=!1;return})},FacetItemClick=function(t){e(t).prop("checked")==1&&e(t.parentElement.parentElement.parentElement).prev().find(".pv-filterpanel-accordion-heading-clear").css("visibility","visible"),FilterCollection(!1)},FacetSliderDrag=function(t,n,r){var i=e(t),s=i.slider("option","min"),o=i.slider("option","max");n=="(no info)"&&(n=0),n>s||r<o?(i.parent().find(".pv-filterpanel-numericslider-range-val").text(n+" - "+r),i.slider("values",0,n),i.slider("values",1,r),i.parent().parent().prev().find(".pv-filterpanel-accordion-heading-clear").css("visibility","visible")):n==s&&r==o&&i.parent().parent().prev().find(".pv-filterpanel-accordion-heading-clear").css("visibility","hidden"),FilterCollection(!1)},e.fn.PivotViewer=function(t){if(H[t])return H[t].apply(this,Array.prototype.slice.call(arguments,1));if(typeof t=="object"||!t)return H.init.apply(this,arguments);e.error("Method "+t+" does not exist on jQuery.PivotViewer")}}(jQuery);